name: Setup

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-uv.outputs.cache-hit }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Cache UV and dependencies
      id: cache-uv
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/uv
          .venv
        key: uv-${{ runner.os }}-python-${{ inputs.python-version }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          uv-${{ runner.os }}-python-${{ inputs.python-version }}-

    - name: Install UV
      if: steps.cache-uv.outputs.cache-hit != 'true'
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      if: steps.cache-uv.outputs.cache-hit != 'true'
      run: |
        uv sync --extra dev

    - name: Verify setup
      run: |
        uv run python --version
        uv run pytest --version