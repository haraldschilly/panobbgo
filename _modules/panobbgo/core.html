<!DOCTYPE html>
<html lang="en" data-accent-color="blue" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>panobbgo.core - Panobbgo 0.0.1pre documentation</title><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=43bd62f4" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=44020203" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="panobbgo.core"/>
    <meta name="twitter:card" content="summary"/>
  </head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="../../index.html">
      
      
      <strong>Panobbgo</strong>
    </a>
    <div class="sy-head-nav" id="head-nav">
      <nav class="sy-head-links"><ul><li class="link">
          <a href="https://github.com/haraldschilly/panobbgo">
            <span>GitHub</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials">
  <a href="https://github.com/haraldschilly/panobbgo" aria-label="GitHub">
    <iconify-icon icon="simple-icons:github"></iconify-icon>
  </a></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="head-nav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2"></span>
          <span class="hamburger_3"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide.html">Panobbgo User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide_setup.html">Setup and Quick Start Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide_introduction.html">Introduction to Panobbgo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide_mathematical_foundation.html">Mathematical Foundation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide_architecture.html">Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide_usage.html">Usage Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide_extending.html">Extending Panobbgo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide_research.html">Research Context and Future Directions</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../core.html">Core Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">Configuration Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">Utilities Module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../strategies.html">Strategies Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../heuristics.html">Heuristics Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzers.html">Analyzers Module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../classic.html">Classic Problems Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lib.html">Library Module</a></li>
</ul>

        </div>
      </div>
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-lucide close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div></div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
<div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-lucide menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Panobbgo</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li><li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">panobbgo.core</strong>
        <meta itemprop="position" content="3" />
      </li></ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-lucide outdent"></i>
      </button>
    </div>
  </div>
</div><div class="flex flex-col break-words justify-between">
      <div class="relative min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
  <article class="yue" role="main">
          <h1>Source code for panobbgo.core</h1><div class="highlight"><pre>
<span></span><span data-line="1"><span class="c1"># -*- coding: utf8 -*-</span>
</span><span data-line="2"><span class="c1"># Copyright 2012 -- 2013 Harald Schilly &lt;harald.schilly@gmail.com&gt;</span>
</span><span data-line="3"><span class="c1">#</span>
</span><span data-line="4"><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span data-line="5"><span class="c1"># you may not use this file except in compliance with the License.</span>
</span><span data-line="6"><span class="c1"># You may obtain a copy of the License at</span>
</span><span data-line="7"><span class="c1">#</span>
</span><span data-line="8"><span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span data-line="9"><span class="c1">#</span>
</span><span data-line="10"><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span><span data-line="11"><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span data-line="12"><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span data-line="13"><span class="c1"># See the License for the specific language governing permissions and</span>
</span><span data-line="14"><span class="c1"># limitations under the License.</span>
</span><span data-line="15">
</span><span data-line="16"><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="17"><span class="sd">Core</span>
</span><span data-line="18"><span class="sd">====</span>
</span><span data-line="19">
</span><span data-line="20"><span class="sd">This is the core part. It contains the essential components</span>
</span><span data-line="21"><span class="sd">and base-classes for the modules:</span>
</span><span data-line="22">
</span><span data-line="23"><span class="sd">- :class:`.Results`: Database of all results, with some rudimentary queries and statistics.</span>
</span><span data-line="24"><span class="sd">- :class:`.EventBus`: This is the backbone for communicating between the strategy,</span>
</span><span data-line="25"><span class="sd">  the heuristics and the analyzers.</span>
</span><span data-line="26"><span class="sd">- &quot;abstract&quot; base-classes for the modules</span>
</span><span data-line="27">
</span><span data-line="28"><span class="sd">  - :mod:`.heuristics`</span>
</span><span data-line="29"><span class="sd">  - :mod:`.analyzers`.</span>
</span><span data-line="30">
</span><span data-line="31"><span class="sd">- and most importantly, the :class:`.StrategyBase` which holds everything together and</span>
</span><span data-line="32"><span class="sd">  subclasses in :mod:`.strategies` implement the actual strategies.</span>
</span><span data-line="33">
</span><span data-line="34"><span class="sd">.. inheritance-diagram:: panobbgo.core</span>
</span><span data-line="35">
</span><span data-line="36"><span class="sd">.. codeauthor:: Harald Schilly &lt;harald.schilly@gmail.com&gt;</span>
</span><span data-line="37"><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="38">
</span><span data-line="39"><span class="kn">from</span><span class="w"> </span><span class="nn">.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
</span><span data-line="40"><span class="kn">from</span><span class="w"> </span><span class="nn">panobbgo.lib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Result</span><span class="p">,</span> <span class="n">Point</span>
</span><span data-line="41"><span class="kn">from</span><span class="w"> </span><span class="nn">panobbgo.lib.constraints</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span data-line="42">    <span class="n">DefaultConstraintHandler</span><span class="p">,</span>
</span><span data-line="43">    <span class="n">PenaltyConstraintHandler</span><span class="p">,</span>
</span><span data-line="44">    <span class="n">DynamicPenaltyConstraintHandler</span><span class="p">,</span>
</span><span data-line="45">    <span class="n">AugmentedLagrangianConstraintHandler</span><span class="p">,</span>
</span><span data-line="46">    <span class="n">EpsilonConstraintHandler</span><span class="p">,</span>
</span><span data-line="47"><span class="p">)</span>
</span><span data-line="48"><span class="kn">from</span><span class="w"> </span><span class="nn">.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">PanobbgoLogger</span>
</span><span data-line="49"><span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">time_module</span>
</span><span data-line="50"><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span data-line="51"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">cast</span>
</span><span data-line="52">
</span><span data-line="53"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span data-line="54">    <span class="kn">from</span><span class="w"> </span><span class="nn">.lib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Problem</span><span class="p">,</span> <span class="n">Result</span>
</span><span data-line="55">    <span class="kn">from</span><span class="w"> </span><span class="nn">.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventBus</span>
</span><span data-line="56">
</span><span data-line="57">
<div class="viewcode-block" id="Results">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Results">[docs]</a>
</span><span data-line="58"><span class="k">class</span><span class="w"> </span><span class="nc">Results</span><span class="p">:</span>
</span><span data-line="59"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="60"><span class="sd">    A very simple database of results with a notification for new results.</span>
</span><span data-line="61"><span class="sd">    The new results are fed directly by the :class:`.StrategyBase`, outside of the</span>
</span><span data-line="62"><span class="sd">    :class:`.EventBus`.</span>
</span><span data-line="63">
</span><span data-line="64"><span class="sd">    .. Note::</span>
</span><span data-line="65">
</span><span data-line="66"><span class="sd">      Later on, maybe this will be a cool actual database which allows to</span>
</span><span data-line="67"><span class="sd">      persistently store past evaluations for a given problem.</span>
</span><span data-line="68"><span class="sd">      This would allow resuming and further a-posteriory analysis.</span>
</span><span data-line="69"><span class="sd">      In the meantime, this is a pandas DataFrame.</span>
</span><span data-line="70"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="71">
</span><span data-line="72">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
</span><span data-line="73">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;RSLTS&quot;</span><span class="p">)</span>
</span><span data-line="74">        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
</span><span data-line="75">        <span class="bp">self</span><span class="o">.</span><span class="n">eventbus</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">eventbus</span>
</span><span data-line="76">        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">problem</span>
</span><span data-line="77">        <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="78">        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="79">        <span class="bp">self</span><span class="o">.</span><span class="n">_best_fx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span data-line="80">        <span class="bp">self</span><span class="o">.</span><span class="n">_last_nb</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># for logging</span>
</span><span data-line="81">        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span data-line="82">
</span><span data-line="83">        <span class="c1"># Initialize storage backend if configured</span>
</span><span data-line="84">        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="85">        <span class="k">if</span> <span class="p">(</span>
</span><span data-line="86">            <span class="nb">hasattr</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;storage_backend&quot;</span><span class="p">)</span>
</span><span data-line="87">            <span class="ow">and</span> <span class="n">strategy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage_backend</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span>
</span><span data-line="88">        <span class="p">):</span>
</span><span data-line="89">            <span class="kn">from</span><span class="w"> </span><span class="nn">.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLiteStorage</span>
</span><span data-line="90">
</span><span data-line="91">            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">SQLiteStorage</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage_uri</span><span class="p">)</span>
</span><span data-line="92">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="93">                <span class="sa">f</span><span class="s2">&quot;Using SQLite storage backend: </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage_uri</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="94">            <span class="p">)</span>
</span><span data-line="95">
<div class="viewcode-block" id="Results.load_from_storage">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Results.load_from_storage">[docs]</a>
</span><span data-line="96">    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="97"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="98"><span class="sd">        Load results from storage backend and populate the database.</span>
</span><span data-line="99"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="100">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">:</span>
</span><span data-line="101">            <span class="n">loaded_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span><span data-line="102">            <span class="k">if</span> <span class="n">loaded_results</span><span class="p">:</span>
</span><span data-line="103">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results from storage.&quot;</span><span class="p">)</span>
</span><span data-line="104">                <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">loaded_results</span><span class="p">,</span> <span class="n">save_to_storage</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="105">                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_results</span><span class="p">)</span>
</span><span data-line="106">        <span class="k">return</span> <span class="mi">0</span></div>

</span><span data-line="107">
</span><span data-line="108">    <span class="nd">@property</span>
</span><span data-line="109">    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="110">        <span class="bp">self</span><span class="o">.</span><span class="n">_flush_buffer</span><span class="p">()</span>
</span><span data-line="111">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span>
</span><span data-line="112">
</span><span data-line="113">    <span class="nd">@results</span><span class="o">.</span><span class="n">setter</span>
</span><span data-line="114">    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span data-line="115">        <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span> <span class="o">=</span> <span class="n">value</span>
</span><span data-line="116">        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="117">        <span class="c1"># Update best_fx from new results</span>
</span><span data-line="118">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span data-line="119">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="120">                <span class="bp">self</span><span class="o">.</span><span class="n">_best_fx</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;fx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span data-line="121">            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span data-line="122">                <span class="bp">self</span><span class="o">.</span><span class="n">_best_fx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span data-line="123">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="124">            <span class="bp">self</span><span class="o">.</span><span class="n">_best_fx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
</span><span data-line="125">
</span><span data-line="126">    <span class="k">def</span><span class="w"> </span><span class="nf">_flush_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="127"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="128"><span class="sd">        Flush buffered results to the DataFrame.</span>
</span><span data-line="129"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="130">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">:</span>
</span><span data-line="131">            <span class="k">return</span>
</span><span data-line="132">
</span><span data-line="133">        <span class="kn">from</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">MultiIndex</span><span class="p">,</span> <span class="n">concat</span>
</span><span data-line="134">
</span><span data-line="135">        <span class="c1"># Initialize DataFrame if needed</span>
</span><span data-line="136">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="137">            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="138">            <span class="n">midx_x</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">x</span><span class="p">))]</span>
</span><span data-line="139">            <span class="n">len_cv_vec</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">cv_vec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">cv_vec</span><span class="p">)</span>
</span><span data-line="140">            <span class="n">midx_cv</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;cv_vec&quot;</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_cv_vec</span><span class="p">)]</span>
</span><span data-line="141">            <span class="n">midx</span> <span class="o">=</span> <span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
</span><span data-line="142">                <span class="n">midx_x</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;fx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">+</span> <span class="n">midx_cv</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;who&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span data-line="143">            <span class="p">)</span>
</span><span data-line="144">            <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">midx</span><span class="p">)</span>
</span><span data-line="145">
</span><span data-line="146">        <span class="c1"># Build data with explicit types to avoid mixed-type array issues</span>
</span><span data-line="147">        <span class="c1"># (np.r_ with strings causes all values to become object dtype)</span>
</span><span data-line="148">        <span class="n">n_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>
</span><span data-line="149">        <span class="n">r0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span data-line="150">        <span class="n">dim_x</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r0</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</span><span data-line="151">        <span class="n">len_cv_vec</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">r0</span><span class="o">.</span><span class="n">cv_vec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">r0</span><span class="o">.</span><span class="n">cv_vec</span><span class="p">)</span>
</span><span data-line="152">
</span><span data-line="153">        <span class="c1"># Pre-allocate typed arrays</span>
</span><span data-line="154">        <span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_results</span><span class="p">,</span> <span class="n">dim_x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span data-line="155">        <span class="n">fx_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_results</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span data-line="156">        <span class="n">cv_vec_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_results</span><span class="p">,</span> <span class="n">len_cv_vec</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">if</span> <span class="n">len_cv_vec</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="157">        <span class="n">cv_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_results</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span data-line="158">        <span class="n">who_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_results</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>  <span class="c1"># strings</span>
</span><span data-line="159">        <span class="n">error_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_results</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span data-line="160">
</span><span data-line="161">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">):</span>
</span><span data-line="162">            <span class="n">x_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span>
</span><span data-line="163">            <span class="n">fx_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">fx</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">fx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span data-line="164">            <span class="k">if</span> <span class="n">cv_vec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="165">                <span class="n">cv_vec_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cv_vec</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">cv_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span data-line="166">            <span class="n">cv_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">cv</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">cv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span data-line="167">            <span class="n">who_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">who</span>
</span><span data-line="168">            <span class="n">error_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">error</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span data-line="169">
</span><span data-line="170">        <span class="c1"># Build DataFrame with proper column types</span>
</span><span data-line="171">        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="172">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_x</span><span class="p">):</span>
</span><span data-line="173">            <span class="n">data_dict</span><span class="p">[(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">x_data</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
</span><span data-line="174">        <span class="n">data_dict</span><span class="p">[(</span><span class="s2">&quot;fx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fx_data</span>
</span><span data-line="175">        <span class="k">if</span> <span class="n">cv_vec_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="176">            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_cv_vec</span><span class="p">):</span>
</span><span data-line="177">                <span class="n">data_dict</span><span class="p">[(</span><span class="s2">&quot;cv_vec&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cv_vec_data</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
</span><span data-line="178">        <span class="n">data_dict</span><span class="p">[(</span><span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cv_data</span>
</span><span data-line="179">        <span class="n">data_dict</span><span class="p">[(</span><span class="s2">&quot;who&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">who_data</span>
</span><span data-line="180">        <span class="n">data_dict</span><span class="p">[(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">error_data</span>
</span><span data-line="181">
</span><span data-line="182">        <span class="n">results_new</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</span><span data-line="183">        <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span> <span class="o">=</span> <span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span><span class="p">,</span> <span class="n">results_new</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="184">        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="185">
<div class="viewcode-block" id="Results.add_results">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Results.add_results">[docs]</a>
</span><span data-line="186">    <span class="k">def</span><span class="w"> </span><span class="nf">add_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_results</span><span class="p">,</span> <span class="n">save_to_storage</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span data-line="187"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="188"><span class="sd">        Add one single or a list of new @Result objects.</span>
</span><span data-line="189"><span class="sd">        Then, publish a ``new_result`` event.</span>
</span><span data-line="190"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="191">        <span class="c1"># Persist to storage backend if enabled</span>
</span><span data-line="192">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="ow">and</span> <span class="n">save_to_storage</span><span class="p">:</span>
</span><span data-line="193">            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">new_results</span><span class="p">)</span>
</span><span data-line="194">
</span><span data-line="195">        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_results</span><span class="p">:</span>
</span><span data-line="196">            <span class="k">return</span>
</span><span data-line="197">
</span><span data-line="198">        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">Result</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">new_results</span><span class="p">])</span>
</span><span data-line="199">        <span class="c1"># notification for all received results at once</span>
</span><span data-line="200">        <span class="bp">self</span><span class="o">.</span><span class="n">eventbus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;new_results&quot;</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">new_results</span><span class="p">)</span>
</span><span data-line="201">
</span><span data-line="202">        <span class="c1"># Prepare stats for progress reporting</span>
</span><span data-line="203">        <span class="n">progress_stats</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="204">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="205">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="206">                <span class="c1"># Use cached min fx if available, or calculate it</span>
</span><span data-line="207">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span><span class="p">):</span>
</span><span data-line="208">                    <span class="n">fx_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;fx&#39;</span><span class="p">]</span>
</span><span data-line="209">                    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fx_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span data-line="210">
</span><span data-line="211">                <span class="n">progress_stats</span><span class="p">[</span><span class="s1">&#39;current_best_fx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span>
</span><span data-line="212">
</span><span data-line="213">                <span class="c1"># Only access dataframe if necessary for other stats</span>
</span><span data-line="214">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="215">                    <span class="n">fx_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;fx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span data-line="216">
</span><span data-line="217">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span data-line="218">                        <span class="n">sorted_fx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fx_series</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
</span><span data-line="219">                        <span class="n">threshold_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_fx</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
</span><span data-line="220">                        <span class="k">if</span> <span class="n">threshold_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="221">                            <span class="n">progress_stats</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorted_fx</span><span class="p">[</span><span class="n">threshold_idx</span><span class="p">]</span>
</span><span data-line="222">
</span><span data-line="223">                    <span class="c1"># min of history excluding last element (general improvement baseline)</span>
</span><span data-line="224">                    <span class="n">progress_stats</span><span class="p">[</span><span class="s1">&#39;prev_best&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fx_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span data-line="225">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span data-line="226">                <span class="k">pass</span>
</span><span data-line="227">
</span><span data-line="228">        <span class="c1"># Report progress for each result</span>
</span><span data-line="229">        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">new_results</span><span class="p">:</span>
</span><span data-line="230">            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_fx</span><span class="p">:</span>
</span><span data-line="231">                <span class="bp">self</span><span class="o">.</span><span class="n">_best_fx</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span>
</span><span data-line="232">            <span class="bp">self</span><span class="o">.</span><span class="n">_report_evaluation_progress</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="n">progress_stats</span><span class="p">)</span>
</span><span data-line="233">
</span><span data-line="234">        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_results</span><span class="p">)</span>
</span><span data-line="235">
</span><span data-line="236">        <span class="c1"># Update cached min fx with new results</span>
</span><span data-line="237">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="238">            <span class="c1"># Calculate min of new results efficiently</span>
</span><span data-line="239">            <span class="n">new_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">fx</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">new_results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">fx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span data-line="240">            <span class="k">if</span> <span class="n">new_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="241">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span><span class="p">)</span> <span class="ow">or</span> <span class="n">new_min</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span><span class="p">:</span>
</span><span data-line="242">                    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_min_fx</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_min</span><span class="p">)</span>
</span><span data-line="243">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span data-line="244">            <span class="k">pass</span>
</span><span data-line="245">
</span><span data-line="246">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_nb</span> <span class="o">//</span> <span class="mi">100</span><span class="p">:</span>
</span><span data-line="247">            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span><span data-line="248">            <span class="bp">self</span><span class="o">.</span><span class="n">_last_nb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

</span><span data-line="249">
<div class="viewcode-block" id="Results.info">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Results.info">[docs]</a>
</span><span data-line="250">    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="251">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> results in DB&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</span><span data-line="252">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="253">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dataframe Results:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span></div>

</span><span data-line="254">
</span><span data-line="255">    <span class="k">def</span><span class="w"> </span><span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
</span><span data-line="256">        <span class="bp">self</span><span class="o">.</span><span class="n">add_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span data-line="257">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="258">
</span><span data-line="259">    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="260">        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
</span><span data-line="261">        <span class="n">l</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span>
</span><span data-line="262">        <span class="k">return</span> <span class="n">l</span>
</span><span data-line="263">
<div class="viewcode-block" id="Results.get_history">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Results.get_history">[docs]</a>
</span><span data-line="264">    <span class="k">def</span><span class="w"> </span><span class="nf">get_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="265"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="266"><span class="sd">        Retrieve the last n results as numpy arrays.</span>
</span><span data-line="267">
</span><span data-line="268"><span class="sd">        Args:</span>
</span><span data-line="269"><span class="sd">            n (int, optional): Number of recent results to retrieve. If None, returns all.</span>
</span><span data-line="270">
</span><span data-line="271"><span class="sd">        Returns:</span>
</span><span data-line="272"><span class="sd">            dict: Dictionary with keys &#39;x&#39;, &#39;fx&#39;, &#39;cv&#39;, &#39;cv_vec&#39;, &#39;who&#39;, &#39;error&#39;.</span>
</span><span data-line="273"><span class="sd">                  Values are numpy arrays (or list/array of objects for &#39;who&#39;).</span>
</span><span data-line="274"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="275">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span data-line="276">            <span class="k">return</span> <span class="p">{</span>
</span><span data-line="277">                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
</span><span data-line="278">                <span class="s2">&quot;fx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
</span><span data-line="279">                <span class="s2">&quot;cv&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
</span><span data-line="280">                <span class="s2">&quot;cv_vec&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
</span><span data-line="281">                <span class="s2">&quot;who&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
</span><span data-line="282">                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
</span><span data-line="283">            <span class="p">}</span>
</span><span data-line="284">
</span><span data-line="285">        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
</span><span data-line="286">        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="287">            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
</span><span data-line="288">
</span><span data-line="289">        <span class="c1"># Extract data using column names</span>
</span><span data-line="290">        <span class="c1"># &#39;x&#39; is a top-level column with sub-columns 0, 1, ...</span>
</span><span data-line="291">        <span class="c1"># df[&#39;x&#39;] returns a DataFrame. .values converts to numpy array (N, dim)</span>
</span><span data-line="292">        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span data-line="293">
</span><span data-line="294">        <span class="c1"># &#39;fx&#39; is (&#39;fx&#39;, 0)</span>
</span><span data-line="295">        <span class="n">fx</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="s2">&quot;fx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span data-line="296">
</span><span data-line="297">        <span class="c1"># &#39;cv&#39; is (&#39;cv&#39;, 0)</span>
</span><span data-line="298">        <span class="n">cv</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="s2">&quot;cv&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span data-line="299">
</span><span data-line="300">        <span class="c1"># &#39;cv_vec&#39; might not exist or might have multiple columns</span>
</span><span data-line="301">        <span class="k">if</span> <span class="s2">&quot;cv_vec&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
</span><span data-line="302">            <span class="n">cv_vec</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cv_vec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span data-line="303">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="304">            <span class="c1"># If no constraint vector, return empty array with shape (N, 0)</span>
</span><span data-line="305">            <span class="n">cv_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
</span><span data-line="306">
</span><span data-line="307">        <span class="c1"># &#39;who&#39; is (&#39;who&#39;, 0)</span>
</span><span data-line="308">        <span class="n">who</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="s2">&quot;who&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span data-line="309">
</span><span data-line="310">        <span class="c1"># &#39;error&#39; is (&#39;error&#39;, 0)</span>
</span><span data-line="311">        <span class="n">error</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span><span data-line="312">
</span><span data-line="313">        <span class="k">return</span> <span class="p">{</span>
</span><span data-line="314">            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
</span><span data-line="315">            <span class="s2">&quot;fx&quot;</span><span class="p">:</span> <span class="n">fx</span><span class="p">,</span>
</span><span data-line="316">            <span class="s2">&quot;cv&quot;</span><span class="p">:</span> <span class="n">cv</span><span class="p">,</span>
</span><span data-line="317">            <span class="s2">&quot;cv_vec&quot;</span><span class="p">:</span> <span class="n">cv_vec</span><span class="p">,</span>
</span><span data-line="318">            <span class="s2">&quot;who&quot;</span><span class="p">:</span> <span class="n">who</span><span class="p">,</span>
</span><span data-line="319">            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
</span><span data-line="320">        <span class="p">}</span></div>

</span><span data-line="321">
</span><span data-line="322">    <span class="k">def</span><span class="w"> </span><span class="nf">_report_evaluation_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Result</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="323"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="324"><span class="sd">        Report progress for a single evaluation result.</span>
</span><span data-line="325">
</span><span data-line="326"><span class="sd">        Args:</span>
</span><span data-line="327"><span class="sd">            result: The evaluation result to report</span>
</span><span data-line="328"><span class="sd">            stats: Optional dictionary of pre-calculated statistics</span>
</span><span data-line="329"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="330">        <span class="kn">from</span><span class="w"> </span><span class="nn">.logging.progress</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProgressContext</span>
</span><span data-line="331">
</span><span data-line="332">        <span class="c1"># Get strategy&#39;s logger for progress reporting</span>
</span><span data-line="333">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="s1">&#39;panobbgo_logger&#39;</span><span class="p">):</span>
</span><span data-line="334">            <span class="k">return</span>  <span class="c1"># No logger configured, skip progress reporting</span>
</span><span data-line="335">
</span><span data-line="336">        <span class="n">progress_reporter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">panobbgo_logger</span><span class="o">.</span><span class="n">progress_reporter</span>
</span><span data-line="337">
</span><span data-line="338">        <span class="c1"># Determine progress context</span>
</span><span data-line="339">        <span class="n">context</span> <span class="o">=</span> <span class="n">ProgressContext</span><span class="p">()</span>
</span><span data-line="340">
</span><span data-line="341">        <span class="c1"># Only analyze if we have valid fx</span>
</span><span data-line="342">        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="343">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="344">                <span class="c1"># Check if this is a new global best</span>
</span><span data-line="345">                <span class="c1"># Use pre-calculated stats if available (more efficient)</span>
</span><span data-line="346">                <span class="k">if</span> <span class="n">stats</span> <span class="ow">and</span> <span class="s1">&#39;current_best_fx&#39;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
</span><span data-line="347">                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;current_best_fx&#39;</span><span class="p">]:</span>
</span><span data-line="348">                        <span class="n">context</span><span class="o">.</span><span class="n">is_global_best</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="349">                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_fx</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_best_fx</span><span class="p">:</span>
</span><span data-line="350">                    <span class="c1"># Fallback to cached _best_fx (updated in add_results)</span>
</span><span data-line="351">                    <span class="n">context</span><span class="o">.</span><span class="n">is_global_best</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="352">
</span><span data-line="353">                <span class="c1"># Check for significant improvement (top 10% of results)</span>
</span><span data-line="354">                <span class="c1"># Use pre-calculated threshold if available</span>
</span><span data-line="355">                <span class="k">if</span> <span class="n">stats</span> <span class="ow">and</span> <span class="s1">&#39;threshold&#39;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
</span><span data-line="356">                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">]:</span>
</span><span data-line="357">                        <span class="n">context</span><span class="o">.</span><span class="n">is_significant_improvement</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="358">                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span data-line="359">                    <span class="c1"># Use _results_df directly to avoid flushing buffer</span>
</span><span data-line="360">                    <span class="c1"># Apply astype(float) to avoid string comparison bug</span>
</span><span data-line="361">                    <span class="n">fx_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;fx&#39;</span><span class="p">]</span>
</span><span data-line="362">                    <span class="n">sorted_fx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fx_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()])</span>
</span><span data-line="363">                    <span class="n">threshold_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_fx</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># top 10%</span>
</span><span data-line="364">                    <span class="k">if</span> <span class="n">threshold_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="365">                        <span class="n">threshold</span> <span class="o">=</span> <span class="n">sorted_fx</span><span class="p">[</span><span class="n">threshold_idx</span><span class="p">]</span>
</span><span data-line="366">                        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
</span><span data-line="367">                            <span class="n">context</span><span class="o">.</span><span class="n">is_significant_improvement</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="368">
</span><span data-line="369">                <span class="c1"># Check for general improvement over previous results</span>
</span><span data-line="370">                <span class="k">if</span> <span class="n">stats</span> <span class="ow">and</span> <span class="s1">&#39;prev_best&#39;</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
</span><span data-line="371">                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;prev_best&#39;</span><span class="p">]:</span>
</span><span data-line="372">                        <span class="n">context</span><span class="o">.</span><span class="n">is_improvement</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="373">                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="374">                    <span class="c1"># Use _results_df directly to avoid flushing buffer</span>
</span><span data-line="375">                    <span class="c1"># Apply astype(float) to avoid string comparison bug</span>
</span><span data-line="376">                    <span class="n">fx_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;fx&#39;</span><span class="p">]</span>
</span><span data-line="377">                    <span class="n">prev_best</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fx_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</span><span data-line="378">                    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="o">&lt;</span> <span class="n">prev_best</span><span class="p">:</span>
</span><span data-line="379">                        <span class="n">context</span><span class="o">.</span><span class="n">is_improvement</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="380">            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
</span><span data-line="381">                <span class="c1"># If we can&#39;t determine improvement status, skip it</span>
</span><span data-line="382">                <span class="k">pass</span>
</span><span data-line="383">
</span><span data-line="384">        <span class="c1"># Check for failure (fx is None or has error)</span>
</span><span data-line="385">        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fx</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span data-line="386">            <span class="n">context</span><span class="o">.</span><span class="n">evaluation_failed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="387">
</span><span data-line="388">        <span class="c1"># Check for warnings (constraint violations, etc.)</span>
</span><span data-line="389">        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">cv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">cv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="390">            <span class="n">context</span><span class="o">.</span><span class="n">has_warnings</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="391">
</span><span data-line="392">        <span class="c1"># Report the evaluation</span>
</span><span data-line="393">        <span class="n">progress_reporter</span><span class="o">.</span><span class="n">report_evaluation</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></div>

</span><span data-line="394">
</span><span data-line="395">
<div class="viewcode-block" id="Module">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Module">[docs]</a>
</span><span data-line="396"><span class="k">class</span><span class="w"> </span><span class="nc">Module</span><span class="p">:</span>
</span><span data-line="397"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="398"><span class="sd">    &quot;Abstract&quot; parent class for various panobbgo modules, e.g.</span>
</span><span data-line="399"><span class="sd">    :class:`.Heuristic` and :class:`.Analyzer`.</span>
</span><span data-line="400"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="401">
<div class="viewcode-block" id="Module.__init__">
<a class="viewcode-back" href="../../_autosummary/panobbgo.core.Module.html#panobbgo.core.Module.__init__">[docs]</a>
</span><span data-line="402">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="403"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="404"><span class="sd">        :param StrategyBase strategy:</span>
</span><span data-line="405"><span class="sd">        :param str name:</span>
</span><span data-line="406"><span class="sd">        @type strategy: StrategyBase</span>
</span><span data-line="407"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="408">        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span data-line="409">        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
</span><span data-line="410">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">config</span>
</span><span data-line="411">        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
</span><span data-line="412">        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="413">        <span class="c1"># implicit dependency check (only class references)</span>
</span><span data-line="414">        <span class="bp">self</span><span class="o">.</span><span class="n">_depends_on</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="415">        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="416">        <span class="bp">self</span><span class="o">.</span><span class="n">eventbus_events</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="417">        <span class="c1"># Ensure logger name is at most 5 characters to satisfy config.get_logger assertion</span>
</span><span data-line="418">        <span class="n">log_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span data-line="419">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">log_name</span><span class="p">)</span></div>

</span><span data-line="420">
</span><span data-line="421">    <span class="nd">@property</span>
</span><span data-line="422">    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="423"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="424"><span class="sd">        The module&#39;s name.</span>
</span><span data-line="425">
</span><span data-line="426"><span class="sd">        .. Note::</span>
</span><span data-line="427">
</span><span data-line="428"><span class="sd">          It should be unique, which is important for</span>
</span><span data-line="429"><span class="sd">          parameterized heuristics or analyzers!</span>
</span><span data-line="430"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="431">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
</span><span data-line="432">
</span><span data-line="433">    <span class="nd">@property</span>
</span><span data-line="434">    <span class="k">def</span><span class="w"> </span><span class="nf">strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;StrategyBase&#39;</span><span class="p">:</span>
</span><span data-line="435">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span>
</span><span data-line="436">
</span><span data-line="437">
</span><span data-line="438">
</span><span data-line="439">    <span class="nd">@property</span>
</span><span data-line="440">    <span class="k">def</span><span class="w"> </span><span class="nf">eventbus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;EventBus&#39;</span><span class="p">:</span>
</span><span data-line="441">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">eventbus</span>
</span><span data-line="442">
</span><span data-line="443">    <span class="nd">@property</span>
</span><span data-line="444">    <span class="k">def</span><span class="w"> </span><span class="nf">problem</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Problem&#39;</span><span class="p">:</span>
</span><span data-line="445">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">problem</span>
</span><span data-line="446">
</span><span data-line="447">    <span class="nd">@property</span>
</span><span data-line="448">    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span data-line="449">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">results</span>
</span><span data-line="450">
<div class="viewcode-block" id="Module.check_dependencies">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Module.check_dependencies">[docs]</a>
</span><span data-line="451">    <span class="k">def</span><span class="w"> </span><span class="nf">check_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyzers</span><span class="p">,</span> <span class="n">heuristics</span><span class="p">):</span>
</span><span data-line="452"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="453"><span class="sd">        This method is called by the core initialization to assess,</span>
</span><span data-line="454"><span class="sd">        if the dependencies for the given module are met.</span>
</span><span data-line="455">
</span><span data-line="456"><span class="sd">        By default, it returns true. Return false if there is</span>
</span><span data-line="457"><span class="sd">        a problem.</span>
</span><span data-line="458">
</span><span data-line="459"><span class="sd">        The arguments are the list of pre-initialized analyzers</span>
</span><span data-line="460"><span class="sd">        and heuristics.</span>
</span><span data-line="461"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="462">        <span class="k">return</span> <span class="kc">True</span></div>

</span><span data-line="463">
</span><span data-line="464">    <span class="k">def</span><span class="w"> </span><span class="nf">__start__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="465"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="466"><span class="sd">        This method should be overwritten by the respective subclass.</span>
</span><span data-line="467"><span class="sd">        It is called in the 2nd initialization phase, inside :meth:`._init_module`.</span>
</span><span data-line="468"><span class="sd">        Now, the strategy and all its components (e.g. :class:`panobbgo.lib.Problem`, ...)</span>
</span><span data-line="469"><span class="sd">        are available.</span>
</span><span data-line="470"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="471">        <span class="k">pass</span>
</span><span data-line="472">
</span><span data-line="473">    <span class="k">def</span><span class="w"> </span><span class="nf">__stop__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="474"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="475"><span class="sd">        Called right at the end after the strategy has finished.</span>
</span><span data-line="476"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="477">        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="478">
</span><span data-line="479">        <span class="c1"># First, ensure all event queues have at least one termination event</span>
</span><span data-line="480">        <span class="c1"># to unblock any threads waiting on get(block=True)</span>
</span><span data-line="481">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;eventbus_events&#39;</span><span class="p">):</span>
</span><span data-line="482">            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventbus_events</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="483">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="484">                    <span class="c1"># Create a dummy termination event if not already stopped</span>
</span><span data-line="485">                    <span class="kn">from</span><span class="w"> </span><span class="nn">.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span>
</span><span data-line="486">                    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
</span><span data-line="487">                    <span class="n">event</span><span class="o">.</span><span class="n">terminate</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="488">                    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="489">                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span data-line="490">                    <span class="k">pass</span>
</span><span data-line="491">
</span><span data-line="492">        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
</span><span data-line="493">            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span><span data-line="494">                <span class="c1"># Don&#39;t use t._Thread__stop(), it&#39;s unsafe and deprecated</span>
</span><span data-line="495">                <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Wait with timeout to avoid permanent hang</span>
</span><span data-line="496">                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span><span data-line="497">                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Thread </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> did not terminate gracefully.&quot;</span><span class="p">)</span>
</span><span data-line="498">
</span><span data-line="499">    <span class="k">def</span><span class="w"> </span><span class="nf">_init_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="500"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="501"><span class="sd">        This plot initializer is called right after the :meth:`._init` method.</span>
</span><span data-line="502"><span class="sd">        It could be used to tell the (optionally enabled) :module:`user interface &lt;.ui&gt;` that</span>
</span><span data-line="503"><span class="sd">        this module wants to have a tab for displaying and visualizing some data.</span>
</span><span data-line="504">
</span><span data-line="505"><span class="sd">        It has to return a tuple consisting of a string as the label of the tab,</span>
</span><span data-line="506"><span class="sd">        and a gtk container (e.g. :class:`gtk.VBox`)</span>
</span><span data-line="507">
</span><span data-line="508"><span class="sd">        To trigger a redraw after an update, call the ``.draw_idle()`` method</span>
</span><span data-line="509"><span class="sd">        of the :class:`~matplotlib.backends.backend_gtkagg.FigureCnavasGTKAgg`.</span>
</span><span data-line="510"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="511">        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span data-line="512">
</span><span data-line="513">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="514">        <span class="k">return</span> <span class="s2">&quot;Module </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>

</span><span data-line="515">
</span><span data-line="516">
<div class="viewcode-block" id="StopHeuristic">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StopHeuristic">[docs]</a>
</span><span data-line="517"><span class="k">class</span><span class="w"> </span><span class="nc">StopHeuristic</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span data-line="518"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="519"><span class="sd">    Indicates the heuristic has finished and should be ignored/removed.</span>
</span><span data-line="520"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="521">
</span><span data-line="522">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;stopped&quot;</span><span class="p">):</span>
</span><span data-line="523"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="524"><span class="sd">        Args:</span>
</span><span data-line="525">
</span><span data-line="526"><span class="sd">        - ``msg``: a custom message, will be visible in the log. (default: &quot;stopped&quot;)</span>
</span><span data-line="527"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="528">        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>

</span><span data-line="529">
</span><span data-line="530">
<div class="viewcode-block" id="Heuristic">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Heuristic">[docs]</a>
</span><span data-line="531"><span class="k">class</span><span class="w"> </span><span class="nc">Heuristic</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="532"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="533"><span class="sd">    This is the &quot;abstract&quot; parent class for all types of point generating classes,</span>
</span><span data-line="534"><span class="sd">    which we call collectively &quot;:mod:`Heuristics &lt;.heuristics&gt;`&quot;.</span>
</span><span data-line="535">
</span><span data-line="536"><span class="sd">    Such a heuristic is capable of the following:</span>
</span><span data-line="537">
</span><span data-line="538"><span class="sd">    #. They can be parameterized by passing in optional arguments in the constructor.</span>
</span><span data-line="539"><span class="sd">       This should be reflected in the :attr:`~.Module.name`!</span>
</span><span data-line="540"><span class="sd">    #. The :class:`.EventBus` spawns a thread for each ``on_*`` method</span>
</span><span data-line="541"><span class="sd">       and calls them when a corresponding :class:`.Event` occurs.</span>
</span><span data-line="542"><span class="sd">    #. Of course, they are capable of storing their state in the instance.</span>
</span><span data-line="543"><span class="sd">       This is also the way of how information is shared between those threads.</span>
</span><span data-line="544"><span class="sd">    #. The `main purpose` of a heuristic is to emit new search points</span>
</span><span data-line="545"><span class="sd">       by calling either :meth:`.emit` or returning a list of points.</span>
</span><span data-line="546"><span class="sd">       The datatype must be :class:`numpy.ndarray` of</span>
</span><span data-line="547"><span class="sd">       `floats &lt;http://docs.scipy.org/doc/numpy/reference/arrays.scalars.html&gt;`_.</span>
</span><span data-line="548"><span class="sd">    #. Additionally, the can get hold of other heuristics or anayzers via the strategy instance.</span>
</span><span data-line="549"><span class="sd">    #. The :class:`.EventBus` inside this strategy instance allows them to publish their</span>
</span><span data-line="550"><span class="sd">       own events, too. This can be used to signal related heuristics something</span>
</span><span data-line="551"><span class="sd">       or to queue up tasks for itself.</span>
</span><span data-line="552"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="553">
<div class="viewcode-block" id="Heuristic.__init__">
<a class="viewcode-back" href="../../_autosummary/panobbgo.core.Heuristic.html#panobbgo.core.Heuristic.__init__">[docs]</a>
</span><span data-line="554">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="555">        <span class="n">Module</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span data-line="556">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">config</span>
</span><span data-line="557">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;HEUR&quot;</span><span class="p">)</span>
</span><span data-line="558">        <span class="bp">self</span><span class="o">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cap</span> <span class="k">if</span> <span class="n">cap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">capacity</span>
</span><span data-line="559">        <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="560">        <span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>
</span><span data-line="561">
</span><span data-line="562">        <span class="bp">self</span><span class="o">.</span><span class="n">_output</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cap</span><span class="p">)</span>
</span><span data-line="563">
</span><span data-line="564">        <span class="c1"># statistics; performance</span>
</span><span data-line="565">        <span class="bp">self</span><span class="o">.</span><span class="n">performance</span> <span class="o">=</span> <span class="mf">0.0</span></div>

</span><span data-line="566">
<div class="viewcode-block" id="Heuristic.clear_output">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Heuristic.clear_output">[docs]</a>
</span><span data-line="567">    <span class="k">def</span><span class="w"> </span><span class="nf">clear_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="568">        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span>
</span><span data-line="569">        <span class="k">with</span> <span class="n">q</span><span class="o">.</span><span class="n">not_full</span><span class="p">:</span>
</span><span data-line="570">            <span class="c1"># with q.mutex:</span>
</span><span data-line="571">            <span class="c1"># del self._output.queue[:]  # LifoQueue</span>
</span><span data-line="572">            <span class="n">q</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Queue</span>
</span><span data-line="573">            <span class="n">q</span><span class="o">.</span><span class="n">not_full</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>  <span class="c1"># to wakeup &quot;put()&quot;</span></div>

</span><span data-line="574">
<div class="viewcode-block" id="Heuristic.emit">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Heuristic.emit">[docs]</a>
</span><span data-line="575">    <span class="k">def</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
</span><span data-line="576"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="577"><span class="sd">        This is used to send out new search points for evaluation.</span>
</span><span data-line="578"><span class="sd">        Args:</span>
</span><span data-line="579">
</span><span data-line="580"><span class="sd">        - ``points``: Either a :class:`numpy.ndarray` of ``float64`` or preferrably a list of them.</span>
</span><span data-line="581"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="582">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span><span class="p">:</span>
</span><span data-line="583">            <span class="k">raise</span> <span class="n">StopHeuristic</span><span class="p">()</span>
</span><span data-line="584">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="585">            <span class="k">if</span> <span class="n">points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="586">                <span class="k">raise</span> <span class="n">StopHeuristic</span><span class="p">()</span>
</span><span data-line="587">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
</span><span data-line="588">                <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">points</span><span class="p">]</span>
</span><span data-line="589">            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
</span><span data-line="590">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span data-line="591">                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;point is not a numpy ndarray&quot;</span><span class="p">)</span>
</span><span data-line="592">                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
</span><span data-line="593">                <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="594">                <span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>  <span class="c1"># Non-blocking put</span>
</span><span data-line="595">        <span class="k">except</span> <span class="n">StopHeuristic</span><span class="p">:</span>
</span><span data-line="596">            <span class="bp">self</span><span class="o">.</span><span class="n">_stopped</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="597">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; heuristic stopped.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="598">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="599">            <span class="c1"># Queue might be full or other issues - silently ignore for non-blocking behavior</span>
</span><span data-line="600">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to emit point from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="601">            <span class="k">pass</span></div>

</span><span data-line="602">
<div class="viewcode-block" id="Heuristic.get_points">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Heuristic.get_points">[docs]</a>
</span><span data-line="603">    <span class="k">def</span><span class="w"> </span><span class="nf">get_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="604"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="605"><span class="sd">        this drains the output Queue until ``limit``</span>
</span><span data-line="606"><span class="sd">        elements are removed or the Queue is empty.</span>
</span><span data-line="607"><span class="sd">        For each actually emitted point,</span>
</span><span data-line="608"><span class="sd">        the performance value is discounted (i.e. &quot;punishment&quot; or &quot;energy</span>
</span><span data-line="609"><span class="sd">        consumption&quot;)</span>
</span><span data-line="610"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="611">        <span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Empty</span>
</span><span data-line="612">
</span><span data-line="613">        <span class="n">new_points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="614">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="615">            <span class="k">while</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
</span><span data-line="616">                <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span><span data-line="617">        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
</span><span data-line="618">            <span class="k">pass</span>
</span><span data-line="619">        <span class="k">return</span> <span class="n">new_points</span></div>

</span><span data-line="620">
</span><span data-line="621">    <span class="nd">@property</span>
</span><span data-line="622">    <span class="k">def</span><span class="w"> </span><span class="nf">active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="623"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="624"><span class="sd">        This is queried by the strategy to determine, if it should still consider it.</span>
</span><span data-line="625"><span class="sd">        This is the case, iff there is still something in its output queue</span>
</span><span data-line="626"><span class="sd">        or if there is a chance that there will be something in the future (at least</span>
</span><span data-line="627"><span class="sd">        one thread is running).</span>
</span><span data-line="628"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="629">        <span class="n">t</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">)</span>
</span><span data-line="630">        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span data-line="631">        <span class="k">return</span> <span class="n">t</span> <span class="ow">or</span> <span class="n">q</span></div>

</span><span data-line="632">
</span><span data-line="633">
<div class="viewcode-block" id="HeuristicSubprocess">
<a class="viewcode-back" href="../../core.html#panobbgo.core.HeuristicSubprocess">[docs]</a>
</span><span data-line="634"><span class="k">class</span><span class="w"> </span><span class="nc">HeuristicSubprocess</span><span class="p">(</span><span class="n">Heuristic</span><span class="p">):</span>
</span><span data-line="635"><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="636"><span class="sd">    This Heuristic is a subclass of :class:`.Heuristic`, which is additionally starting</span>
</span><span data-line="637"><span class="sd">    a subprocess, which communicates with the main thread via a pipe in a blocking</span>
</span><span data-line="638"><span class="sd">    communication scheme.</span>
</span><span data-line="639"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="640">
<div class="viewcode-block" id="HeuristicSubprocess.__init__">
<a class="viewcode-back" href="../../_autosummary/panobbgo.core.HeuristicSubprocess.html#panobbgo.core.HeuristicSubprocess.__init__">[docs]</a>
</span><span data-line="641">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="642">        <span class="n">Heuristic</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">cap</span><span class="o">=</span><span class="n">cap</span><span class="p">)</span>
</span><span data-line="643">
</span><span data-line="644">        <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
</span><span data-line="645">        
</span><span data-line="646">        <span class="c1"># Use &#39;spawn&#39; context to avoid DeprecationWarning: use of fork() may lead to deadlocks</span>
</span><span data-line="647">        <span class="c1"># in multi-threaded process. &#39;spawn&#39; is safer and cross-platform.</span>
</span><span data-line="648">        <span class="n">ctx</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s2">&quot;spawn&quot;</span><span class="p">)</span>
</span><span data-line="649">
</span><span data-line="650">        <span class="c1"># a pipe has two ends, parent and child.</span>
</span><span data-line="651">        <span class="bp">self</span><span class="o">.</span><span class="n">pipe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe_child</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
</span><span data-line="652">        <span class="bp">self</span><span class="o">.</span><span class="n">__subprocess</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
</span><span data-line="653">            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subprocess</span><span class="p">,</span>
</span><span data-line="654">            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipe_child</span><span class="p">,),</span>
</span><span data-line="655">            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-subprocess&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
</span><span data-line="656">        <span class="p">)</span>
</span><span data-line="657">        <span class="bp">self</span><span class="o">.</span><span class="n">__subprocess</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="658">        <span class="bp">self</span><span class="o">.</span><span class="n">__subprocess</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

</span><span data-line="659">
<div class="viewcode-block" id="HeuristicSubprocess.subprocess">
<a class="viewcode-back" href="../../core.html#panobbgo.core.HeuristicSubprocess.subprocess">[docs]</a>
</span><span data-line="660">    <span class="nd">@staticmethod</span>
</span><span data-line="661">    <span class="k">def</span><span class="w"> </span><span class="nf">subprocess</span><span class="p">(</span><span class="n">pipe</span><span class="p">):</span>
</span><span data-line="662"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="663"><span class="sd">        overwrite this pipe.recv() &amp; pipe.send() loop and</span>
</span><span data-line="664"><span class="sd">        compute something in between.</span>
</span><span data-line="665"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="666">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span data-line="667">            <span class="n">payload</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span><span data-line="668">            <span class="n">pipe</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;subprocess received: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">payload</span><span class="p">)</span></div>
</div>

</span><span data-line="669">
</span><span data-line="670">
</span><span data-line="671"><span class="c1">#</span>
</span><span data-line="672"><span class="c1"># Analyzer</span>
</span><span data-line="673"><span class="c1">#</span>
<div class="viewcode-block" id="Analyzer">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Analyzer">[docs]</a>
</span><span data-line="674"><span class="k">class</span><span class="w"> </span><span class="nc">Analyzer</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
</span><span data-line="675"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="676"><span class="sd">    Abstract parent class for all types of analyzers.</span>
</span><span data-line="677"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="678">
<div class="viewcode-block" id="Analyzer.__init__">
<a class="viewcode-back" href="../../_autosummary/panobbgo.core.Analyzer.html#panobbgo.core.Analyzer.__init__">[docs]</a>
</span><span data-line="679">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="680">        <span class="n">Module</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>
</div>

</span><span data-line="681">
</span><span data-line="682">
</span><span data-line="683"><span class="c1">#</span>
</span><span data-line="684"><span class="c1"># EventBus</span>
</span><span data-line="685"><span class="c1">#</span>
</span><span data-line="686">
</span><span data-line="687">
<div class="viewcode-block" id="Event">
<a class="viewcode-back" href="../../core.html#panobbgo.core.Event">[docs]</a>
</span><span data-line="688"><span class="k">class</span><span class="w"> </span><span class="nc">Event</span><span class="p">:</span>
</span><span data-line="689"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="690"><span class="sd">    This class holds the data for one single :class:`~.EventBus` event.</span>
</span><span data-line="691"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="692">
<div class="viewcode-block" id="Event.__init__">
<a class="viewcode-back" href="../../_autosummary/panobbgo.core.Event.html#panobbgo.core.Event.__init__">[docs]</a>
</span><span data-line="693">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="694">        <span class="bp">self</span><span class="o">.</span><span class="n">_when</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="695">        <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="696">        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span data-line="697">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="698">            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>

</span><span data-line="699">
</span><span data-line="700">    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="701">        <span class="k">return</span> <span class="s2">&quot;Event[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span></div>

</span><span data-line="702">
</span><span data-line="703">
<div class="viewcode-block" id="EventBus">
<a class="viewcode-back" href="../../core.html#panobbgo.core.EventBus">[docs]</a>
</span><span data-line="704"><span class="k">class</span><span class="w"> </span><span class="nc">EventBus</span><span class="p">:</span>
</span><span data-line="705"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="706"><span class="sd">    This event bus is used to publish and send events.</span>
</span><span data-line="707"><span class="sd">    E.g. it is used to send information like &quot;new best point&quot;</span>
</span><span data-line="708"><span class="sd">    to all subscribing heuristics.</span>
</span><span data-line="709"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="710">
</span><span data-line="711">    <span class="c1"># pattern for a valid key</span>
</span><span data-line="712">    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span data-line="713">
</span><span data-line="714">    <span class="n">_re_key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-z_]+$&quot;</span><span class="p">)</span>
</span><span data-line="715">
<div class="viewcode-block" id="EventBus.__init__">
<a class="viewcode-back" href="../../_autosummary/panobbgo.core.EventBus.html#panobbgo.core.EventBus.__init__">[docs]</a>
</span><span data-line="716">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span data-line="717">        <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="718">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span data-line="719">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;EVBUS&quot;</span><span class="p">)</span></div>

</span><span data-line="720">
</span><span data-line="721">    <span class="nd">@property</span>
</span><span data-line="722">    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="723"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="724"><span class="sd">        List of all keys where you can send an :class:`Event` to.</span>
</span><span data-line="725"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="726">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="727">
<div class="viewcode-block" id="EventBus.register">
<a class="viewcode-back" href="../../core.html#panobbgo.core.EventBus.register">[docs]</a>
</span><span data-line="728">    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span data-line="729"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="730"><span class="sd">        Registers a given ``target`` for this EventBus instance.</span>
</span><span data-line="731"><span class="sd">        It needs to have suitable ``on_&lt;key&gt;`` methods.</span>
</span><span data-line="732"><span class="sd">        For each of them, a :class:`~threading.Thread` is spawn as a daemon.</span>
</span><span data-line="733">
</span><span data-line="734"><span class="sd">        :param Module target:</span>
</span><span data-line="735"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="736">        <span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Queue</span>  <span class="c1"># LifoQueue</span>
</span><span data-line="737">        <span class="kn">from</span><span class="w"> </span><span class="nn">threading</span><span class="w"> </span><span class="kn">import</span> <span class="n">Thread</span>
</span><span data-line="738">
</span><span data-line="739">        <span class="c1"># important: this decouples the dispatcher&#39;s thread from the actual</span>
</span><span data-line="740">        <span class="c1"># target</span>
</span><span data-line="741">        <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">drain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span data-line="742">            <span class="k">if</span> <span class="n">drain</span><span class="p">:</span>  <span class="c1"># not using draining for now, doesn&#39;t make much sense</span>
</span><span data-line="743">                <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="744">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span data-line="745">                    <span class="c1"># draining the queue... otherwise it might get really huge</span>
</span><span data-line="746">                    <span class="c1"># it&#39;s up to the heuristics to only work with the most</span>
</span><span data-line="747">                    <span class="c1"># important points</span>
</span><span data-line="748">                    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="749">                    <span class="n">terminate</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="750">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="751">                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span data-line="752">                            <span class="n">event</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">eventbus_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="n">isfirst</span><span class="p">)</span>
</span><span data-line="753">                            <span class="n">terminate</span> <span class="o">|=</span> <span class="n">event</span><span class="o">.</span><span class="n">terminate</span>
</span><span data-line="754">                            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span data-line="755">                            <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="756">                    <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
</span><span data-line="757">                        <span class="n">isfirst</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="758">
</span><span data-line="759">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="760">                        <span class="n">new_points</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="761">                        <span class="k">try</span><span class="p">:</span>
</span><span data-line="762">                            <span class="n">new_points</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;on_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)(</span><span class="n">events</span><span class="p">)</span>
</span><span data-line="763">                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span data-line="764">                            <span class="k">if</span> <span class="ow">not</span> <span class="n">terminate</span><span class="p">:</span>
</span><span data-line="765">                                <span class="k">raise</span>
</span><span data-line="766">
</span><span data-line="767">                        <span class="c1"># heuristics might call self.emit and/or return a list</span>
</span><span data-line="768">                        <span class="k">if</span> <span class="n">new_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="769">                            <span class="n">target</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">new_points</span><span class="p">)</span>
</span><span data-line="770">
</span><span data-line="771">                        <span class="k">if</span> <span class="n">terminate</span><span class="p">:</span>
</span><span data-line="772">                            <span class="k">raise</span> <span class="n">StopHeuristic</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> terminated&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="773">                    <span class="k">except</span> <span class="n">StopHeuristic</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="774">                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span data-line="775">                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">/on_</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2"> -&gt; unsubscribing.&quot;</span>
</span><span data-line="776">                            <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span data-line="777">                        <span class="p">)</span>
</span><span data-line="778">                        <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span><span data-line="779">                        <span class="k">return</span>
</span><span data-line="780">
</span><span data-line="781">            <span class="k">else</span><span class="p">:</span>  <span class="c1"># not draining (default)</span>
</span><span data-line="782">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span data-line="783">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="784">                        <span class="n">event</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">eventbus_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="785">                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">Event</span><span class="p">)</span>
</span><span data-line="786">                        <span class="k">try</span><span class="p">:</span>
</span><span data-line="787">                            <span class="n">new_points</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="788">                            <span class="k">try</span><span class="p">:</span>
</span><span data-line="789">                                <span class="n">new_points</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;on_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)(</span><span class="o">**</span><span class="n">event</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>
</span><span data-line="790">                            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span data-line="791">                                <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">terminate</span><span class="p">:</span>
</span><span data-line="792">                                    <span class="k">raise</span>
</span><span data-line="793">
</span><span data-line="794">                            <span class="c1"># heuristics might call self.emit and/or return a</span>
</span><span data-line="795">                            <span class="c1"># list</span>
</span><span data-line="796">                            <span class="k">if</span> <span class="n">new_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="797">                                <span class="n">target</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">new_points</span><span class="p">)</span>
</span><span data-line="798">
</span><span data-line="799">                            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">terminate</span><span class="p">:</span>
</span><span data-line="800">                                <span class="k">raise</span> <span class="n">StopHeuristic</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> terminated&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="801">                        <span class="k">except</span> <span class="n">StopHeuristic</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="802">                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span data-line="803">                                <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">/on_</span><span class="si">%s</span><span class="s2">&#39; </span><span class="si">%s</span><span class="s2"> -&gt; unsubscribing.&quot;</span>
</span><span data-line="804">                                <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span data-line="805">                            <span class="p">)</span>
</span><span data-line="806">                            <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span><span data-line="807">                            <span class="k">return</span>
</span><span data-line="808">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="809">                        <span class="c1"># usually, they only happen during shutdown</span>
</span><span data-line="810">                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span data-line="811">                            <span class="c1"># sys.exc_info() -&gt; re-create original exception</span>
</span><span data-line="812">                            <span class="c1"># (otherwise we don&#39;t know the actual cause!)</span>
</span><span data-line="813">                            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span data-line="814">                            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
</span><span data-line="815">                            <span class="k">if</span> <span class="n">exc_info</span><span class="p">:</span>
</span><span data-line="816">                                <span class="n">e</span> <span class="o">=</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span data-line="817">                                <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="818">                                    <span class="k">raise</span> <span class="n">e</span>
</span><span data-line="819">                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># just issue a critical warning</span>
</span><span data-line="820">                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
</span><span data-line="821">                                <span class="s2">&quot;Exception: </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span data-line="822">                            <span class="p">)</span>
</span><span data-line="823">                        <span class="k">return</span>
</span><span data-line="824">
</span><span data-line="825">        <span class="n">target</span><span class="o">.</span><span class="n">eventbus_events</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="826">        <span class="c1"># bind all &#39;on_&lt;key&gt;&#39; methods to events in the eventbus</span>
</span><span data-line="827">        <span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</span><span data-line="828">
</span><span data-line="829">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">):</span>
</span><span data-line="830">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;on_&quot;</span><span class="p">):</span>
</span><span data-line="831">                <span class="k">continue</span>
</span><span data-line="832">            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_key</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</span><span data-line="833">            <span class="n">target</span><span class="o">.</span><span class="n">eventbus_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
</span><span data-line="834">            <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
</span><span data-line="835">                <span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">,</span>
</span><span data-line="836">                <span class="n">args</span><span class="o">=</span><span class="p">(</span>
</span><span data-line="837">                    <span class="n">key</span><span class="p">,</span>
</span><span data-line="838">                    <span class="n">target</span><span class="p">,</span>
</span><span data-line="839">                <span class="p">),</span>
</span><span data-line="840">                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;EventBus::</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
</span><span data-line="841">            <span class="p">)</span>
</span><span data-line="842">            <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
</span><span data-line="843">            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span data-line="844">            <span class="n">target</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span data-line="845">            <span class="c1"># thread running, now subscribe to events</span>
</span><span data-line="846">            <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></div>

</span><span data-line="847">            <span class="c1"># logger.debug(&quot;%s subscribed and running.&quot; % t.name)</span>
</span><span data-line="848">
</span><span data-line="849">    <span class="nd">@staticmethod</span>
</span><span data-line="850">    <span class="k">def</span><span class="w"> </span><span class="nf">_check_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
</span><span data-line="851">        <span class="k">if</span> <span class="ow">not</span> <span class="n">EventBus</span><span class="o">.</span><span class="n">_re_key</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
</span><span data-line="852">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; key not allowed&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="853">        <span class="k">return</span> <span class="n">key</span>
</span><span data-line="854">
<div class="viewcode-block" id="EventBus.subscribe">
<a class="viewcode-back" href="../../core.html#panobbgo.core.EventBus.subscribe">[docs]</a>
</span><span data-line="855">    <span class="k">def</span><span class="w"> </span><span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span data-line="856"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="857"><span class="sd">        Called by :meth:`.register`.</span>
</span><span data-line="858">
</span><span data-line="859"><span class="sd">        .. Note:: counterpart is :func:`unsubscribe`.</span>
</span><span data-line="860"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="861">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="862">        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">:</span>
</span><span data-line="863">            <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="864">
</span><span data-line="865">        <span class="k">assert</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span data-line="866">        <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>

</span><span data-line="867">
<div class="viewcode-block" id="EventBus.unsubscribe">
<a class="viewcode-back" href="../../core.html#panobbgo.core.EventBus.unsubscribe">[docs]</a>
</span><span data-line="868">    <span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span data-line="869"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="870"><span class="sd">        Args:</span>
</span><span data-line="871">
</span><span data-line="872"><span class="sd">        - if ``key`` is ``None``, the target is removed from all keys.</span>
</span><span data-line="873">
</span><span data-line="874"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="875">        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="876">            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="877">                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
</span><span data-line="878">                    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="n">target</span><span class="p">:</span>
</span><span data-line="879">                        <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span data-line="880">            <span class="k">return</span>
</span><span data-line="881">
</span><span data-line="882">        <span class="bp">self</span><span class="o">.</span><span class="n">_check_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span data-line="883">        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">:</span>
</span><span data-line="884">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;cannot unsubscribe unknown key &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="885">            <span class="k">return</span>
</span><span data-line="886">
</span><span data-line="887">        <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
</span><span data-line="888">            <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>

</span><span data-line="889">
<div class="viewcode-block" id="EventBus.publish">
<a class="viewcode-back" href="../../core.html#panobbgo.core.EventBus.publish">[docs]</a>
</span><span data-line="890">    <span class="k">def</span><span class="w"> </span><span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="891"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="892"><span class="sd">        Publishes a new :class:`.Event` to all subscribers,</span>
</span><span data-line="893"><span class="sd">        who listen to the given ``key``.</span>
</span><span data-line="894"><span class="sd">        It is either possible to send an existing event or to create an event</span>
</span><span data-line="895"><span class="sd">        object on the fly with the given ``**kwargs``.</span>
</span><span data-line="896">
</span><span data-line="897"><span class="sd">        Args:</span>
</span><span data-line="898">
</span><span data-line="899"><span class="sd">        - ``event``: if set, this given :class:`.Event` is sent (and not a new one created).</span>
</span><span data-line="900"><span class="sd">        - ``terminate``: if True, the associated thread will end.</span>
</span><span data-line="901"><span class="sd">                         (use it for ``on_start`` and similar).</span>
</span><span data-line="902"><span class="sd">        - ``**kwargs``: any additional keyword arguments are stored inside the Event</span>
</span><span data-line="903"><span class="sd">                        if ``event`` is ``None``.</span>
</span><span data-line="904"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="905">        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">:</span>
</span><span data-line="906">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
</span><span data-line="907">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;key &#39;</span><span class="si">%s</span><span class="s2">&#39; unknown.&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
</span><span data-line="908">            <span class="k">return</span>
</span><span data-line="909">
</span><span data-line="910">        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subs</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
</span><span data-line="911">            <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">event</span>
</span><span data-line="912">            <span class="n">event</span><span class="o">.</span><span class="n">terminate</span> <span class="o">=</span> <span class="n">terminate</span>
</span><span data-line="913">            <span class="c1"># logger.info(&quot;EventBus: publishing %s -&gt; %s&quot; % (key, event))</span>
</span><span data-line="914">            <span class="n">target</span><span class="o">.</span><span class="n">eventbus_events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div>
</div>

</span><span data-line="915">
</span><span data-line="916">
<div class="viewcode-block" id="StrategyBase">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase">[docs]</a>
</span><span data-line="917"><span class="k">class</span><span class="w"> </span><span class="nc">StrategyBase</span><span class="p">:</span>
</span><span data-line="918"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="919"><span class="sd">    This abstract BaseStrategy is the parent class of all Strategies.</span>
</span><span data-line="920">
</span><span data-line="921"><span class="sd">    Use it this way:</span>
</span><span data-line="922">
</span><span data-line="923"><span class="sd">    #. Subclass it, write your optional initializer, *afterwards* call the initializer</span>
</span><span data-line="924"><span class="sd">       of this class (it will start its the main loop).</span>
</span><span data-line="925">
</span><span data-line="926"><span class="sd">    #. Overwrite the :meth:`.execute`, which returns a list of new search points</span>
</span><span data-line="927"><span class="sd">       (by requesting them from the :mod:`~panobbgo.heuristics` via the</span>
</span><span data-line="928"><span class="sd">       :meth:`~panobbgo.core.Heuristic.get_points` method) and might</span>
</span><span data-line="929"><span class="sd">       also emit :class:`Events &lt;panobbgo.core.Event&gt;`.</span>
</span><span data-line="930">
</span><span data-line="931"><span class="sd">    This ``execute`` method will be called repeatedly as long as there are less than the</span>
</span><span data-line="932"><span class="sd">    given maximum number of search points evaluated.</span>
</span><span data-line="933"><span class="sd">    &quot;&quot;&quot;</span>
</span><span data-line="934">
</span><span data-line="935">    <span class="c1"># constant reference id for sending the evaluation code to workers</span>
</span><span data-line="936">    <span class="n">PROBLEM_KEY</span> <span class="o">=</span> <span class="s2">&quot;problem&quot;</span>
</span><span data-line="937">
<div class="viewcode-block" id="StrategyBase.__init__">
<a class="viewcode-back" href="../../_autosummary/panobbgo.core.StrategyBase.html#panobbgo.core.StrategyBase.__init__">[docs]</a>
</span><span data-line="938">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">parse_args</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">testing_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="939"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="940">
</span><span data-line="941">
</span><span data-line="942"><span class="sd">        @type problem: panobbgo.lib.Problem</span>
</span><span data-line="943"><span class="sd">        @param problem:</span>
</span><span data-line="944"><span class="sd">        @param parse_args:</span>
</span><span data-line="945"><span class="sd">        @param testing_mode:</span>
</span><span data-line="946"><span class="sd">        @param kwargs: Additional configuration parameters (e.g. max_eval, max_evaluations)</span>
</span><span data-line="947"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="948">        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span data-line="949">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">parse_args</span><span class="p">,</span> <span class="n">testing_mode</span><span class="o">=</span><span class="n">testing_mode</span><span class="p">)</span>
</span><span data-line="950">
</span><span data-line="951">        <span class="c1"># Handle configuration overrides from kwargs</span>
</span><span data-line="952">        <span class="k">if</span> <span class="s1">&#39;max_evaluations&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span data-line="953">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_evaluations&#39;</span><span class="p">)</span>
</span><span data-line="954">        <span class="k">if</span> <span class="s1">&#39;max_eval&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span data-line="955">             <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_eval&#39;</span><span class="p">)</span>
</span><span data-line="956">
</span><span data-line="957">        <span class="c1"># Apply remaining kwargs to config if they match existing config attributes</span>
</span><span data-line="958">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span data-line="959">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span data-line="960">                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span data-line="961">
</span><span data-line="962">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;STRAT&quot;</span><span class="p">)</span>
</span><span data-line="963">        <span class="bp">self</span><span class="o">.</span><span class="n">slogger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;STATS&quot;</span><span class="p">)</span>
</span><span data-line="964">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Init of &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
</span><span data-line="965">        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">problem</span><span class="p">)</span>
</span><span data-line="966">
</span><span data-line="967">        <span class="c1"># aux configuration</span>
</span><span data-line="968">        <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span data-line="969">
</span><span data-line="970">        <span class="c1"># determine width based on console info</span>
</span><span data-line="971">        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.width&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="972">        <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.precision&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># default 7</span>
</span><span data-line="973">
</span><span data-line="974">        <span class="c1"># statistics</span>
</span><span data-line="975">        <span class="bp">self</span><span class="o">.</span><span class="n">show_last</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># for printing the info line in _add_tasks()</span>
</span><span data-line="976">        <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="977">        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_walltimes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="978">
</span><span data-line="979">        <span class="c1"># task accounting (tasks != points !!!)</span>
</span><span data-line="980">        <span class="bp">self</span><span class="o">.</span><span class="n">jobs_per_client</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># number of tasks per client in &#39;chunksize&#39;</span>
</span><span data-line="981">        <span class="bp">self</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict mapping future id to future object</span>
</span><span data-line="982">        <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="983">        <span class="bp">self</span><span class="o">.</span><span class="n">finished</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="984">
</span><span data-line="985">        <span class="c1"># init &amp; start everything</span>
</span><span data-line="986">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_cluster</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
</span><span data-line="987">        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="988">        <span class="bp">self</span><span class="o">.</span><span class="n">_hs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="989">        <span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
</span><span data-line="990">
</span><span data-line="991">        <span class="bp">self</span><span class="o">.</span><span class="n">_heuristics</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
</span><span data-line="992">        <span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
</span><span data-line="993">        <span class="bp">self</span><span class="o">.</span><span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span>
</span><span data-line="994">        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span> <span class="o">=</span> <span class="kc">False</span>
</span><span data-line="995">
</span><span data-line="996">        <span class="c1"># Configure Constraint Handler</span>
</span><span data-line="997">        <span class="n">rho</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;rho&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">100.0</span>
</span><span data-line="998">        <span class="n">exponent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">constraint_exponent</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;constraint_exponent&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span>
</span><span data-line="999">        <span class="n">rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">dynamic_penalty_rate</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;dynamic_penalty_rate&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.01</span>
</span><span data-line="1000">        <span class="n">handler_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;constraint_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;DefaultConstraintHandler&quot;</span><span class="p">)</span>
</span><span data-line="1001">
</span><span data-line="1002">        <span class="k">if</span> <span class="n">handler_name</span> <span class="o">==</span> <span class="s2">&quot;PenaltyConstraintHandler&quot;</span><span class="p">:</span>
</span><span data-line="1003">            <span class="bp">self</span><span class="o">.</span><span class="n">constraint_handler</span> <span class="o">=</span> <span class="n">PenaltyConstraintHandler</span><span class="p">(</span>
</span><span data-line="1004">                <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="n">exponent</span>
</span><span data-line="1005">            <span class="p">)</span>
</span><span data-line="1006">        <span class="k">elif</span> <span class="n">handler_name</span> <span class="o">==</span> <span class="s2">&quot;DynamicPenaltyConstraintHandler&quot;</span><span class="p">:</span>
</span><span data-line="1007">            <span class="bp">self</span><span class="o">.</span><span class="n">constraint_handler</span> <span class="o">=</span> <span class="n">DynamicPenaltyConstraintHandler</span><span class="p">(</span>
</span><span data-line="1008">                <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho_start</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="n">exponent</span>
</span><span data-line="1009">            <span class="p">)</span>
</span><span data-line="1010">        <span class="k">elif</span> <span class="n">handler_name</span> <span class="o">==</span> <span class="s2">&quot;AugmentedLagrangianConstraintHandler&quot;</span><span class="p">:</span>
</span><span data-line="1011">            <span class="bp">self</span><span class="o">.</span><span class="n">constraint_handler</span> <span class="o">=</span> <span class="n">AugmentedLagrangianConstraintHandler</span><span class="p">(</span>
</span><span data-line="1012">                <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">rate</span>
</span><span data-line="1013">            <span class="p">)</span>
</span><span data-line="1014">        <span class="k">elif</span> <span class="n">handler_name</span> <span class="o">==</span> <span class="s2">&quot;EpsilonConstraintHandler&quot;</span><span class="p">:</span>
</span><span data-line="1015">            <span class="n">epsilon_start</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1016">                <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epsilon_start</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;epsilon_start&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span>
</span><span data-line="1017">            <span class="p">)</span>
</span><span data-line="1018">            <span class="n">epsilon_cp</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1019">                <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epsilon_cp</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;epsilon_cp&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">5.0</span>
</span><span data-line="1020">            <span class="p">)</span>
</span><span data-line="1021">            <span class="n">epsilon_cutoff</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1022">                <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">epsilon_cutoff</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;epsilon_cutoff&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">100</span>
</span><span data-line="1023">            <span class="p">)</span>
</span><span data-line="1024">
</span><span data-line="1025">            <span class="bp">self</span><span class="o">.</span><span class="n">constraint_handler</span> <span class="o">=</span> <span class="n">EpsilonConstraintHandler</span><span class="p">(</span>
</span><span data-line="1026">                <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span data-line="1027">                <span class="n">epsilon_start</span><span class="o">=</span><span class="n">epsilon_start</span><span class="p">,</span>
</span><span data-line="1028">                <span class="n">cp</span><span class="o">=</span><span class="n">epsilon_cp</span><span class="p">,</span>
</span><span data-line="1029">                <span class="n">cutoff</span><span class="o">=</span><span class="n">epsilon_cutoff</span><span class="p">,</span>
</span><span data-line="1030">                <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span>
</span><span data-line="1031">            <span class="p">)</span>
</span><span data-line="1032">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1033">            <span class="bp">self</span><span class="o">.</span><span class="n">constraint_handler</span> <span class="o">=</span> <span class="n">DefaultConstraintHandler</span><span class="p">(</span>
</span><span data-line="1034">                <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span>
</span><span data-line="1035">            <span class="p">)</span>
</span><span data-line="1036">
</span><span data-line="1037">        <span class="bp">self</span><span class="o">.</span><span class="n">eventbus</span> <span class="o">=</span> <span class="n">EventBus</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span data-line="1038">        <span class="bp">self</span><span class="o">.</span><span class="n">eventbus</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint_handler</span><span class="p">)</span>
</span><span data-line="1039">        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">Results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1040">
</span><span data-line="1041">        <span class="c1"># Initialize new logging system</span>
</span><span data-line="1042">        <span class="bp">self</span><span class="o">.</span><span class="n">panobbgo_logger</span> <span class="o">=</span> <span class="n">PanobbgoLogger</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">logging</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;logging&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">{})</span></div>

</span><span data-line="1043">
</span><span data-line="1044">
</span><span data-line="1045">
</span><span data-line="1046">    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1047"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1048"><span class="sd">        Context manager entry. Allows using the strategy in a &#39;with&#39; block.</span>
</span><span data-line="1049"><span class="sd">        Example:</span>
</span><span data-line="1050"><span class="sd">            with StrategyRewarding(problem) as strategy:</span>
</span><span data-line="1051"><span class="sd">                strategy.start()</span>
</span><span data-line="1052"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1053">        <span class="k">return</span> <span class="bp">self</span>
</span><span data-line="1054">
</span><span data-line="1055">    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
</span><span data-line="1056"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1057"><span class="sd">        Context manager exit. Ensures resource cleanup even if exceptions occur.</span>
</span><span data-line="1058"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1059">        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>
</span><span data-line="1060">
<div class="viewcode-block" id="StrategyBase.add">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.add">[docs]</a>
</span><span data-line="1061">    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Heur</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span data-line="1062">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;init: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Heur</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
</span><span data-line="1063">        <span class="bp">self</span><span class="o">.</span><span class="n">_hs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Heur</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

</span><span data-line="1064">
<div class="viewcode-block" id="StrategyBase.start">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.start">[docs]</a>
</span><span data-line="1065">    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1066">        <span class="c1"># heuristics</span>
</span><span data-line="1067">        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
</span><span data-line="1068">            <span class="bp">self</span><span class="o">.</span><span class="n">add_heuristic</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span data-line="1069">
</span><span data-line="1070">        <span class="c1"># analyzers</span>
</span><span data-line="1071">        <span class="kn">from</span><span class="w"> </span><span class="nn">.analyzers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Best</span><span class="p">,</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">Splitter</span><span class="p">,</span> <span class="n">Convergence</span>
</span><span data-line="1072">
</span><span data-line="1073">        <span class="n">new_analyzers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Best</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">Grid</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">Splitter</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">Convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
</span><span data-line="1074">        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">new_analyzers</span><span class="p">:</span>
</span><span data-line="1075">            <span class="bp">self</span><span class="o">.</span><span class="n">add_analyzer</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span data-line="1076">
</span><span data-line="1077">        <span class="bp">self</span><span class="o">.</span><span class="n">check_dependencies</span><span class="p">()</span>
</span><span data-line="1078">
</span><span data-line="1079">        <span class="c1"># Validate framework setup before starting optimization</span>
</span><span data-line="1080">        <span class="bp">self</span><span class="o">.</span><span class="n">validate_setup</span><span class="p">()</span>
</span><span data-line="1081">
</span><span data-line="1082">        <span class="c1"># Load previous results if storage is enabled</span>
</span><span data-line="1083">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;load_from_storage&quot;</span><span class="p">):</span>
</span><span data-line="1084">            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">load_from_storage</span><span class="p">()</span>
</span><span data-line="1085">
</span><span data-line="1086">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;EventBus keys: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventbus</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>
</span><span data-line="1087">
</span><span data-line="1088">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1089">            <span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
</span><span data-line="1090">
</span><span data-line="1091">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span><span data-line="1092">                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;change run() to start()&quot;</span><span class="p">)</span>
</span><span data-line="1093">            <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">()</span>
</span><span data-line="1094">        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span data-line="1095">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;KeyboardInterrupt received, e.g. via Ctrl-C&quot;</span><span class="p">)</span>
</span><span data-line="1096">            <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span></div>

</span><span data-line="1097">
</span><span data-line="1098">    <span class="nd">@property</span>
</span><span data-line="1099">    <span class="k">def</span><span class="w"> </span><span class="nf">heuristics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1100">        <span class="k">return</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heuristics</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">active</span><span class="p">]</span>
</span><span data-line="1101">
</span><span data-line="1102">    <span class="nd">@property</span>
</span><span data-line="1103">    <span class="k">def</span><span class="w"> </span><span class="nf">analyzers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1104">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span data-line="1105">
<div class="viewcode-block" id="StrategyBase.heuristic">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.heuristic">[docs]</a>
</span><span data-line="1106">    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
</span><span data-line="1107">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heuristics</span><span class="p">[</span><span class="n">who</span><span class="p">]</span></div>

</span><span data-line="1108">
<div class="viewcode-block" id="StrategyBase.analyzer">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.analyzer">[docs]</a>
</span><span data-line="1109">    <span class="k">def</span><span class="w"> </span><span class="nf">analyzer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
</span><span data-line="1110">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span><span class="p">[</span><span class="n">who</span><span class="p">]</span></div>

</span><span data-line="1111">
<div class="viewcode-block" id="StrategyBase.add_heuristic">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.add_heuristic">[docs]</a>
</span><span data-line="1112">    <span class="k">def</span><span class="w"> </span><span class="nf">add_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
</span><span data-line="1113"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1114"><span class="sd">        Add a heuristic to the strategy.</span>
</span><span data-line="1115">
</span><span data-line="1116"><span class="sd">        :param Heuristic h: The heuristic instance to add</span>
</span><span data-line="1117"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1118">        <span class="n">name</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">name</span>
</span><span data-line="1119">        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heuristics</span><span class="p">:</span>
</span><span data-line="1120">            <span class="n">existing_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heuristics</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="1121">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span data-line="1122">                <span class="sa">f</span><span class="s2">&quot;Heuristic name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is already used by another heuristic. &quot;</span>
</span><span data-line="1123">                <span class="sa">f</span><span class="s2">&quot;Each heuristic must have a unique name. &quot;</span>
</span><span data-line="1124">                <span class="sa">f</span><span class="s2">&quot;Existing heuristics: </span><span class="si">{</span><span class="n">existing_names</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="1125">            <span class="p">)</span>
</span><span data-line="1126">        <span class="bp">self</span><span class="o">.</span><span class="n">_heuristics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
</span><span data-line="1127">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1128">            <span class="bp">self</span><span class="o">.</span><span class="n">init_module</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</span><span data-line="1129">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="1130">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span data-line="1131">                <span class="sa">f</span><span class="s2">&quot;Failed to initialize heuristic &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">h</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">). &quot;</span>
</span><span data-line="1132">                <span class="sa">f</span><span class="s2">&quot;This usually indicates an error in the heuristic&#39;s __start__() method. &quot;</span>
</span><span data-line="1133">                <span class="sa">f</span><span class="s2">&quot;Original error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="1134">            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>

</span><span data-line="1135">
<div class="viewcode-block" id="StrategyBase.add_analyzer">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.add_analyzer">[docs]</a>
</span><span data-line="1136">    <span class="k">def</span><span class="w"> </span><span class="nf">add_analyzer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
</span><span data-line="1137"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1138"><span class="sd">        Add an analyzer to the strategy.</span>
</span><span data-line="1139">
</span><span data-line="1140"><span class="sd">        :param Analyzer a: The analyzer instance to add</span>
</span><span data-line="1141"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1142">        <span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span>
</span><span data-line="1143">        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span><span class="p">:</span>
</span><span data-line="1144">            <span class="n">existing_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="1145">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span data-line="1146">                <span class="sa">f</span><span class="s2">&quot;Analyzer name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; is already used by another analyzer. &quot;</span>
</span><span data-line="1147">                <span class="sa">f</span><span class="s2">&quot;Each analyzer must have a unique name. &quot;</span>
</span><span data-line="1148">                <span class="sa">f</span><span class="s2">&quot;Existing analyzers: </span><span class="si">{</span><span class="n">existing_names</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="1149">            <span class="p">)</span>
</span><span data-line="1150">        <span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
</span><span data-line="1151">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1152">            <span class="bp">self</span><span class="o">.</span><span class="n">init_module</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span data-line="1153">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="1154">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span data-line="1155">                <span class="sa">f</span><span class="s2">&quot;Failed to initialize analyzer &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">). &quot;</span>
</span><span data-line="1156">                <span class="sa">f</span><span class="s2">&quot;This usually indicates an error in the analyzer&#39;s __start__() method. &quot;</span>
</span><span data-line="1157">                <span class="sa">f</span><span class="s2">&quot;Original error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="1158">            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>

</span><span data-line="1159">
<div class="viewcode-block" id="StrategyBase.check_dependencies">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.check_dependencies">[docs]</a>
</span><span data-line="1160">    <span class="k">def</span><span class="w"> </span><span class="nf">check_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1161"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1162"><span class="sd">        This method is called in self.start() (and only there)</span>
</span><span data-line="1163"><span class="sd">        for checking all the dependencies of all modules.</span>
</span><span data-line="1164"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1165">        <span class="n">heuristics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_heuristics</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span data-line="1166">        <span class="n">analyzers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span data-line="1167">        <span class="n">all_mods</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">heuristics</span><span class="p">]</span>
</span><span data-line="1168">        <span class="n">all_mods</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="vm">__class__</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">analyzers</span><span class="p">])</span>
</span><span data-line="1169">        <span class="n">all_mods</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_mods</span><span class="p">)</span>
</span><span data-line="1170">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">analyzers</span> <span class="o">+</span> <span class="n">heuristics</span><span class="p">:</span>
</span><span data-line="1171">            <span class="c1"># explicit</span>
</span><span data-line="1172">            <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="o">.</span><span class="n">check_dependencies</span><span class="p">(</span><span class="n">analyzers</span><span class="p">,</span> <span class="n">heuristics</span><span class="p">):</span>
</span><span data-line="1173">                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not satisfy dependencies. #1&quot;</span> <span class="o">%</span> <span class="n">module</span><span class="p">)</span>
</span><span data-line="1174">            <span class="c1"># implicit (just list of respective classes)</span>
</span><span data-line="1175">            <span class="k">for</span> <span class="n">mod_class</span> <span class="ow">in</span> <span class="n">module</span><span class="o">.</span><span class="n">_depends_on</span><span class="p">:</span>
</span><span data-line="1176">                <span class="k">if</span> <span class="n">mod_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_mods</span><span class="p">:</span>
</span><span data-line="1177">                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span data-line="1178">                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> depends on </span><span class="si">%s</span><span class="s2">, but missing.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">mod_class</span><span class="p">)</span>
</span><span data-line="1179">                    <span class="p">)</span></div>

</span><span data-line="1180">
<div class="viewcode-block" id="StrategyBase.validate_setup">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.validate_setup">[docs]</a>
</span><span data-line="1181">    <span class="k">def</span><span class="w"> </span><span class="nf">validate_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1182"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1183"><span class="sd">        Validate that the framework is properly set up before starting optimization.</span>
</span><span data-line="1184">
</span><span data-line="1185"><span class="sd">        This method checks for common configuration errors and missing components</span>
</span><span data-line="1186"><span class="sd">        that would cause the optimization to fail or behave unexpectedly.</span>
</span><span data-line="1187">
</span><span data-line="1188"><span class="sd">        Raises:</span>
</span><span data-line="1189"><span class="sd">            ValueError: If the setup is invalid with descriptive error messages.</span>
</span><span data-line="1190"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1191">        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1192">
</span><span data-line="1193">        <span class="c1"># Check for at least one heuristic</span>
</span><span data-line="1194">        <span class="n">active_heuristics</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heuristics</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">active</span><span class="p">]</span>
</span><span data-line="1195">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_heuristics</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1196">            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="1197">                <span class="s2">&quot;No active heuristics found. You must add at least one heuristic before starting optimization.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="1198">                <span class="s2">&quot;Example: strategy.add(Random)</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="1199">                <span class="s2">&quot;Available heuristics: Center, Zero, Random, Extremal, LatinHypercube, Nearby, WeightedAverage, NelderMead, LBFGSB, QuadraticWlsModel, FeasibleSearch, ConstraintGradient, LocalPenaltySearch, GaussianProcessHeuristic&quot;</span>
</span><span data-line="1200">            <span class="p">)</span>
</span><span data-line="1201">
</span><span data-line="1202">        <span class="c1"># Check for required analyzers</span>
</span><span data-line="1203">        <span class="n">required_analyzers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Best&#39;</span><span class="p">,</span> <span class="s1">&#39;Grid&#39;</span><span class="p">,</span> <span class="s1">&#39;Splitter&#39;</span><span class="p">]</span>
</span><span data-line="1204">        <span class="n">missing_analyzers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1205">        <span class="k">for</span> <span class="n">analyzer_name</span> <span class="ow">in</span> <span class="n">required_analyzers</span><span class="p">:</span>
</span><span data-line="1206">            <span class="k">if</span> <span class="n">analyzer_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span><span class="p">:</span>
</span><span data-line="1207">                <span class="n">missing_analyzers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analyzer_name</span><span class="p">)</span>
</span><span data-line="1208">
</span><span data-line="1209">        <span class="k">if</span> <span class="n">missing_analyzers</span><span class="p">:</span>
</span><span data-line="1210">            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span data-line="1211">                <span class="sa">f</span><span class="s2">&quot;Missing required analyzers: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_analyzers</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span data-line="1212">                <span class="s2">&quot;These analyzers are automatically added by StrategyBase.start(). &quot;</span>
</span><span data-line="1213">                <span class="s2">&quot;If you&#39;re seeing this error, there may be an initialization issue.&quot;</span>
</span><span data-line="1214">            <span class="p">)</span>
</span><span data-line="1215">
</span><span data-line="1216">        <span class="c1"># Check configuration validity</span>
</span><span data-line="1217">        <span class="n">config_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_config</span><span class="p">()</span>
</span><span data-line="1218">        <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">config_errors</span><span class="p">)</span>
</span><span data-line="1219">
</span><span data-line="1220">        <span class="c1"># If any errors found, raise ValueError with all issues</span>
</span><span data-line="1221">        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
</span><span data-line="1222">            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Framework setup validation failed:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span data-line="1223">            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">)</span>
</span><span data-line="1224">            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Please fix these issues before starting optimization.&quot;</span>
</span><span data-line="1225">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span></div>

</span><span data-line="1226">
</span><span data-line="1227">    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1228"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1229"><span class="sd">        Validate configuration parameters.</span>
</span><span data-line="1230">
</span><span data-line="1231"><span class="sd">        Returns:</span>
</span><span data-line="1232"><span class="sd">            List of error messages (empty if no errors).</span>
</span><span data-line="1233"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1234">        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1235">
</span><span data-line="1236">        <span class="c1"># Check max_eval is reasonable</span>
</span><span data-line="1237">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1238">            <span class="n">max_eval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span><span class="p">)</span>
</span><span data-line="1239">            <span class="k">if</span> <span class="n">max_eval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1240">                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max_eval must be positive, got </span><span class="si">{</span><span class="n">max_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="1241">            <span class="k">elif</span> <span class="n">max_eval</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>  <span class="c1"># Reasonable upper bound</span>
</span><span data-line="1242">                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max_eval (</span><span class="si">{</span><span class="n">max_eval</span><span class="si">}</span><span class="s2">) seems unreasonably high. Consider values &lt; 100,000&quot;</span><span class="p">)</span>
</span><span data-line="1243">        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
</span><span data-line="1244">            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max_eval must be a valid integer, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="1245">
</span><span data-line="1246">        <span class="c1"># Check discount factor (used by rewarding strategy)</span>
</span><span data-line="1247">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1248">            <span class="n">discount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">discount</span><span class="p">)</span>
</span><span data-line="1249">            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">discount</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
</span><span data-line="1250">                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;discount must be between 0 and 1, got </span><span class="si">{</span><span class="n">discount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="1251">        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
</span><span data-line="1252">            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;discount must be a valid float between 0 and 1, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">discount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="1253">
</span><span data-line="1254">        <span class="c1"># Check smoothing parameter</span>
</span><span data-line="1255">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1256">            <span class="n">smooth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">smooth</span><span class="p">)</span>
</span><span data-line="1257">            <span class="k">if</span> <span class="n">smooth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1258">                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;smooth must be non-negative, got </span><span class="si">{</span><span class="n">smooth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="1259">        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
</span><span data-line="1260">            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;smooth must be a valid float, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">smooth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span data-line="1261">
</span><span data-line="1262">        <span class="c1"># Check evaluation method</span>
</span><span data-line="1263">        <span class="n">valid_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;threaded&#39;</span><span class="p">,</span> <span class="s1">&#39;processes&#39;</span><span class="p">,</span> <span class="s1">&#39;dask&#39;</span><span class="p">]</span>
</span><span data-line="1264">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_methods</span><span class="p">:</span>
</span><span data-line="1265">            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;evaluation_method must be one of </span><span class="si">{</span><span class="n">valid_methods</span><span class="si">}</span><span class="s2">, got &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span data-line="1266">
</span><span data-line="1267">        <span class="k">return</span> <span class="n">errors</span>
</span><span data-line="1268">
<div class="viewcode-block" id="StrategyBase.init_module">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.init_module">[docs]</a>
</span><span data-line="1269">    <span class="k">def</span><span class="w"> </span><span class="nf">init_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
</span><span data-line="1270"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1271"><span class="sd">        :class:`.StrategyBase` calls this method.</span>
</span><span data-line="1272">
</span><span data-line="1273"><span class="sd">        :param Module module:</span>
</span><span data-line="1274"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1275">        <span class="n">module</span><span class="o">.</span><span class="n">__start__</span><span class="p">()</span>
</span><span data-line="1276">        <span class="c1"># only after _init_ it is ready to receive events</span>
</span><span data-line="1277">        <span class="n">module</span><span class="o">.</span><span class="n">eventbus</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">module</span><span class="p">)</span></div>

</span><span data-line="1278">
</span><span data-line="1279">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
</span><span data-line="1280"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1281"><span class="sd">        Set up evaluation infrastructure based on configuration.</span>
</span><span data-line="1282">
</span><span data-line="1283"><span class="sd">        Evaluation methods:</span>
</span><span data-line="1284"><span class="sd">        - &#39;threaded&#39;: Thread pool for fast testing with pure Python functions (default for tests)</span>
</span><span data-line="1285"><span class="sd">        - &#39;processes&#39;: Subprocess evaluation for isolation (legacy, slower)</span>
</span><span data-line="1286"><span class="sd">        - &#39;dask&#39;: Distributed evaluation for heavy workloads</span>
</span><span data-line="1287"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1288">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
</span><span data-line="1289">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dask_cluster</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
</span><span data-line="1290">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;processes&quot;</span><span class="p">:</span>
</span><span data-line="1291">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_process_evaluation</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
</span><span data-line="1292">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;threaded&quot;</span><span class="p">:</span>
</span><span data-line="1293">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_threaded_evaluation</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
</span><span data-line="1294">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1295">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span data-line="1296">                <span class="sa">f</span><span class="s2">&quot;Unknown evaluation method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="1297">            <span class="p">)</span>
</span><span data-line="1298">
</span><span data-line="1299">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_dask_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
</span><span data-line="1300"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1301"><span class="sd">        Set up a Dask cluster based on configuration.</span>
</span><span data-line="1302"><span class="sd">        Supports both local and remote clusters.</span>
</span><span data-line="1303"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1304">        <span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">LocalCluster</span>
</span><span data-line="1305">
</span><span data-line="1306">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_cluster_type</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
</span><span data-line="1307">            <span class="c1"># Create a local cluster</span>
</span><span data-line="1308">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="1309">                <span class="s2">&quot;Setting up local Dask cluster with </span><span class="si">%d</span><span class="s2"> workers&quot;</span>
</span><span data-line="1310">                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_n_workers</span>
</span><span data-line="1311">            <span class="p">)</span>
</span><span data-line="1312">            <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">(</span>
</span><span data-line="1313">                <span class="n">n_workers</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_n_workers</span><span class="p">),</span>
</span><span data-line="1314">                <span class="n">threads_per_worker</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_threads_per_worker</span><span class="p">),</span>
</span><span data-line="1315">                <span class="n">memory_limit</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_memory_limit</span><span class="p">),</span>
</span><span data-line="1316">                <span class="n">dashboard_address</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_dashboard_address</span><span class="p">),</span>
</span><span data-line="1317">                <span class="n">silence_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span data-line="1318">            <span class="p">)</span>
</span><span data-line="1319">            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span><span class="p">)</span>
</span><span data-line="1320">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1321">            <span class="c1"># Connect to remote cluster</span>
</span><span data-line="1322">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="1323">                <span class="s2">&quot;Connecting to remote Dask cluster at </span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span data-line="1324">                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_scheduler_address</span>
</span><span data-line="1325">            <span class="p">)</span>
</span><span data-line="1326">            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_scheduler_address</span><span class="p">)</span>
</span><span data-line="1327">
</span><span data-line="1328">        <span class="c1"># Scatter the problem to all workers (similar to IPython Reference)</span>
</span><span data-line="1329">        <span class="bp">self</span><span class="o">.</span><span class="n">_problem_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1330">
</span><span data-line="1331">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="1332">            <span class="s2">&quot;Dask cluster ready with </span><span class="si">%d</span><span class="s2"> workers&quot;</span>
</span><span data-line="1333">            <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()[</span><span class="s2">&quot;workers&quot;</span><span class="p">])</span>
</span><span data-line="1334">        <span class="p">)</span>
</span><span data-line="1335">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_cluster_type</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
</span><span data-line="1336">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="1337">                <span class="s2">&quot;Dashboard available at: http://localhost</span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span data-line="1338">                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_dashboard_address</span>
</span><span data-line="1339">            <span class="p">)</span>
</span><span data-line="1340">
</span><span data-line="1341">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_process_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
</span><span data-line="1342"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1343"><span class="sd">        Set up process pool evaluation using subprocesses.</span>
</span><span data-line="1344"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1345">        <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
</span><span data-line="1346">        <span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
</span><span data-line="1347">        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span data-line="1348">        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
</span><span data-line="1349">
</span><span data-line="1350">        <span class="c1"># Store problem for subprocess evaluation</span>
</span><span data-line="1351">        <span class="bp">self</span><span class="o">.</span><span class="n">_problem</span> <span class="o">=</span> <span class="n">problem</span>
</span><span data-line="1352">
</span><span data-line="1353">        <span class="c1"># Determine number of processes (default to number of CPU cores)</span>
</span><span data-line="1354">        <span class="bp">self</span><span class="o">.</span><span class="n">_n_processes</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1355">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_n_workers</span>
</span><span data-line="1356">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;dask_n_workers&quot;</span><span class="p">)</span>
</span><span data-line="1357">            <span class="k">else</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
</span><span data-line="1358">        <span class="p">)</span>
</span><span data-line="1359">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="1360">            <span class="s2">&quot;Setting up process evaluation with </span><span class="si">%d</span><span class="s2"> subprocesses&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_processes</span>
</span><span data-line="1361">        <span class="p">)</span>
</span><span data-line="1362">
</span><span data-line="1363">        <span class="c1"># Create a temporary file to store the problem for subprocesses</span>
</span><span data-line="1364">        <span class="bp">self</span><span class="o">.</span><span class="n">_problem_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
</span><span data-line="1365">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1366">            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_problem_file</span><span class="p">)</span>
</span><span data-line="1367">            <span class="bp">self</span><span class="o">.</span><span class="n">_problem_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1368">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="1369">            <span class="bp">self</span><span class="o">.</span><span class="n">_problem_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1370">            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="1371">            <span class="k">raise</span> <span class="n">e</span>
</span><span data-line="1372">
</span><span data-line="1373">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process evaluation ready&quot;</span><span class="p">)</span>
</span><span data-line="1374">
</span><span data-line="1375">    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_threaded_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">):</span>
</span><span data-line="1376"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1377"><span class="sd">        Set up thread pool evaluation for fast testing with pure Python functions.</span>
</span><span data-line="1378">
</span><span data-line="1379"><span class="sd">        This is ideal for:</span>
</span><span data-line="1380"><span class="sd">        - Unit tests and CI</span>
</span><span data-line="1381"><span class="sd">        - Pure Python objective functions</span>
</span><span data-line="1382"><span class="sd">        - Quick prototyping</span>
</span><span data-line="1383">
</span><span data-line="1384"><span class="sd">        NOT suitable for:</span>
</span><span data-line="1385"><span class="sd">        - External process calls</span>
</span><span data-line="1386"><span class="sd">        - Functions that release the GIL</span>
</span><span data-line="1387"><span class="sd">        - CPU-intensive parallel work (use Dask instead)</span>
</span><span data-line="1388"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1389">        <span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
</span><span data-line="1390">        <span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
</span><span data-line="1391">
</span><span data-line="1392">        <span class="c1"># Store problem directly (shared memory, no pickling needed)</span>
</span><span data-line="1393">        <span class="bp">self</span><span class="o">.</span><span class="n">_problem</span> <span class="o">=</span> <span class="n">problem</span>
</span><span data-line="1394">
</span><span data-line="1395">        <span class="c1"># Determine number of threads</span>
</span><span data-line="1396">        <span class="bp">self</span><span class="o">.</span><span class="n">_n_processes</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1397">            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dask_n_workers</span>
</span><span data-line="1398">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;dask_n_workers&quot;</span><span class="p">)</span>
</span><span data-line="1399">            <span class="k">else</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
</span><span data-line="1400">        <span class="p">)</span>
</span><span data-line="1401">
</span><span data-line="1402">        <span class="c1"># Create thread pool</span>
</span><span data-line="1403">        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_processes</span><span class="p">))</span>
</span><span data-line="1404">        <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Track pending futures</span>
</span><span data-line="1405">
</span><span data-line="1406">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="1407">            <span class="s2">&quot;Threaded evaluation ready with </span><span class="si">%d</span><span class="s2"> threads&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_processes</span>
</span><span data-line="1408">        <span class="p">)</span>
</span><span data-line="1409">
</span><span data-line="1410">    <span class="nd">@property</span>
</span><span data-line="1411">    <span class="k">def</span><span class="w"> </span><span class="nf">best</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1412">        <span class="n">best_analyzer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyzers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Best&quot;</span><span class="p">)</span>
</span><span data-line="1413">        <span class="k">return</span> <span class="n">best_analyzer</span><span class="o">.</span><span class="n">best</span> <span class="k">if</span> <span class="n">best_analyzer</span> <span class="k">else</span> <span class="kc">None</span>
</span><span data-line="1414">
</span><span data-line="1415">    <span class="nd">@property</span>
</span><span data-line="1416">    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1417">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
</span><span data-line="1418">
</span><span data-line="1419">    <span class="nd">@property</span>
</span><span data-line="1420">    <span class="k">def</span><span class="w"> </span><span class="nf">evaluators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1421"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1422"><span class="sd">        Compatibility property for legacy code that references evaluators.</span>
</span><span data-line="1423"><span class="sd">        Returns a mock object with attributes needed by strategies.</span>
</span><span data-line="1424"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1425">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
</span><span data-line="1426">
</span><span data-line="1427">            <span class="k">class</span><span class="w"> </span><span class="nc">DaskEvaluatorsMock</span><span class="p">:</span>
</span><span data-line="1428">                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
</span><span data-line="1429">                    <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
</span><span data-line="1430">
</span><span data-line="1431">                <span class="nd">@property</span>
</span><span data-line="1432">                <span class="k">def</span><span class="w"> </span><span class="nf">outstanding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1433">                    <span class="c1"># Return list of pending task keys</span>
</span><span data-line="1434">                    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="1435">
</span><span data-line="1436">                <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1437">                    <span class="c1"># Return number of Dask workers</span>
</span><span data-line="1438">                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="s2">&quot;_client&quot;</span><span class="p">):</span>
</span><span data-line="1439">                        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">scheduler_info</span><span class="p">()[</span><span class="s2">&quot;workers&quot;</span><span class="p">])</span>
</span><span data-line="1440">                    <span class="k">return</span> <span class="mi">0</span>
</span><span data-line="1441">
</span><span data-line="1442">            <span class="k">return</span> <span class="n">DaskEvaluatorsMock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1443">        <span class="k">else</span><span class="p">:</span>  <span class="c1"># process or threaded evaluation</span>
</span><span data-line="1444">
</span><span data-line="1445">            <span class="k">class</span><span class="w"> </span><span class="nc">DirectEvaluatorsMock</span><span class="p">:</span>
</span><span data-line="1446">                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
</span><span data-line="1447">                    <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
</span><span data-line="1448">
</span><span data-line="1449">                <span class="nd">@property</span>
</span><span data-line="1450">                <span class="k">def</span><span class="w"> </span><span class="nf">outstanding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1451">                    <span class="c1"># Return list of pending task keys</span>
</span><span data-line="1452">                    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span data-line="1453">
</span><span data-line="1454">                <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1455">                    <span class="c1"># Return number of subprocesses</span>
</span><span data-line="1456">                    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="s2">&quot;_n_processes&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span data-line="1457">
</span><span data-line="1458">            <span class="k">return</span> <span class="n">DirectEvaluatorsMock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1459">
</span><span data-line="1460">    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1461">        <span class="bp">self</span><span class="o">.</span><span class="n">eventbus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1462">        <span class="c1"># Give heuristics a moment to process the start event and emit initial points</span>
</span><span data-line="1463">        <span class="n">time_module</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span data-line="1464">        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="1465">        <span class="bp">self</span><span class="o">.</span><span class="n">eventbus</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span data-line="1466">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Strategy &#39;</span><span class="si">%s</span><span class="s2">&#39; started&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
</span><span data-line="1467">        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1468">        <span class="bp">self</span><span class="o">.</span><span class="n">_last_results_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1469">        <span class="bp">self</span><span class="o">.</span><span class="n">_loops_without_progress</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1470">        <span class="bp">self</span><span class="o">.</span><span class="n">_max_loops_without_progress</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># More generous</span>
</span><span data-line="1471">        <span class="n">max_eval_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span> <span class="k">else</span> <span class="mi">1000</span>
</span><span data-line="1472">        <span class="bp">self</span><span class="o">.</span><span class="n">_max_total_loops</span> <span class="o">=</span> <span class="n">max_eval_int</span> <span class="o">*</span> <span class="mi">10000</span>  <span class="c1"># Much more headroom</span>
</span><span data-line="1473">
</span><span data-line="1474">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span data-line="1475">            <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="1476">
</span><span data-line="1477">            <span class="c1"># Safety check: prevent infinite loops</span>
</span><span data-line="1478">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_total_loops</span><span class="p">:</span>
</span><span data-line="1479">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span data-line="1480">                    <span class="sa">f</span><span class="s2">&quot;Strategy exceeded maximum loops (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_total_loops</span><span class="si">}</span><span class="s2">). &quot;</span>
</span><span data-line="1481">                    <span class="sa">f</span><span class="s2">&quot;Results so far: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">. Stopping optimization.&quot;</span>
</span><span data-line="1482">                <span class="p">)</span>
</span><span data-line="1483">                <span class="k">break</span>
</span><span data-line="1484">
</span><span data-line="1485">            <span class="c1"># execute the actual strategy</span>
</span><span data-line="1486">            <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span data-line="1487">
</span><span data-line="1488">            <span class="c1"># Check for progress (points generated)</span>
</span><span data-line="1489">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1490">                <span class="c1"># Only increment if we also don&#39;t have pending tasks</span>
</span><span data-line="1491">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1492">                    <span class="bp">self</span><span class="o">.</span><span class="n">_loops_without_progress</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="1493">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loops_without_progress</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_loops_without_progress</span><span class="p">:</span>
</span><span data-line="1494">                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span data-line="1495">                            <span class="sa">f</span><span class="s2">&quot;No points generated and no pending tasks for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_loops_without_progress</span><span class="si">}</span><span class="s2"> consecutive loops. &quot;</span>
</span><span data-line="1496">                            <span class="sa">f</span><span class="s2">&quot;This may indicate a configuration issue or exhausted search space. &quot;</span>
</span><span data-line="1497">                            <span class="sa">f</span><span class="s2">&quot;Results so far: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span><span class="si">}</span><span class="s2">. Stopping optimization.&quot;</span>
</span><span data-line="1498">                        <span class="p">)</span>
</span><span data-line="1499">                        <span class="k">break</span>
</span><span data-line="1500">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1501">                <span class="bp">self</span><span class="o">.</span><span class="n">_loops_without_progress</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1502">
</span><span data-line="1503">            <span class="c1"># Update progress status</span>
</span><span data-line="1504">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_progress_status</span><span class="p">()</span>
</span><span data-line="1505">
</span><span data-line="1506">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
</span><span data-line="1507">                <span class="bp">self</span><span class="o">.</span><span class="n">_run_dask_evaluation</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span data-line="1508">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;processes&quot;</span><span class="p">:</span>
</span><span data-line="1509">                <span class="bp">self</span><span class="o">.</span><span class="n">_run_process_evaluation</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span data-line="1510">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;threaded&quot;</span><span class="p">:</span>
</span><span data-line="1511">                <span class="bp">self</span><span class="o">.</span><span class="n">_run_threaded_evaluation</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span data-line="1512">
</span><span data-line="1513">            <span class="bp">self</span><span class="o">.</span><span class="n">jobs_per_client</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
</span><span data-line="1514">                <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span> <span class="o">/</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_time_per_task</span><span class="p">))</span>
</span><span data-line="1515">            <span class="p">)</span>
</span><span data-line="1516">
</span><span data-line="1517">            <span class="c1"># show heuristic performances after each round</span>
</span><span data-line="1518">            <span class="c1"># logger.info(&#39;  &#39;.join((&#39;%s:%.3f&#39; % (h, h.performance) for h in</span>
</span><span data-line="1519">            <span class="c1"># heurs)))</span>
</span><span data-line="1520">
</span><span data-line="1521">            <span class="c1"># Check for additional progress (results added)</span>
</span><span data-line="1522">            <span class="n">current_results_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
</span><span data-line="1523">            <span class="k">if</span> <span class="n">current_results_count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_results_count</span><span class="p">:</span>
</span><span data-line="1524">                <span class="c1"># Only increment if we are not generating points either</span>
</span><span data-line="1525">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1526">                    <span class="bp">self</span><span class="o">.</span><span class="n">_loops_without_progress</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="1527">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1528">                <span class="bp">self</span><span class="o">.</span><span class="n">_loops_without_progress</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1529">                <span class="bp">self</span><span class="o">.</span><span class="n">_last_results_count</span> <span class="o">=</span> <span class="n">current_results_count</span>
</span><span data-line="1530">
</span><span data-line="1531">            <span class="c1"># stopping criteria</span>
</span><span data-line="1532">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span><span class="p">:</span>
</span><span data-line="1533">                <span class="k">break</span>
</span><span data-line="1534">
</span><span data-line="1535">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span><span class="p">:</span>
</span><span data-line="1536">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stop requested via flag (e.g. convergence).&quot;</span><span class="p">)</span>
</span><span data-line="1537">                <span class="k">break</span>
</span><span data-line="1538">
</span><span data-line="1539">            <span class="c1"># limit loop speed - sleep briefly</span>
</span><span data-line="1540">            <span class="n">time_module</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span>
</span><span data-line="1541">
</span><span data-line="1542">        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span>
</span><span data-line="1543">
</span><span data-line="1544">    <span class="k">def</span><span class="w"> </span><span class="nf">_run_dask_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
</span><span data-line="1545"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run evaluation using Dask distributed computing.&quot;&quot;&quot;</span>
</span><span data-line="1546">
</span><span data-line="1547">        <span class="c1"># Helper function to evaluate a point using the problem</span>
</span><span data-line="1548">        <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_point</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
</span><span data-line="1549"><span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate a single point using the problem instance&quot;&quot;&quot;</span>
</span><span data-line="1550">            <span class="k">return</span> <span class="n">problem</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
</span><span data-line="1551">
</span><span data-line="1552">        <span class="c1"># distribute work using Dask futures</span>
</span><span data-line="1553">        <span class="c1"># Submit each point as a separate task</span>
</span><span data-line="1554">        <span class="n">new_futures</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1555">        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
</span><span data-line="1556">            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
</span><span data-line="1557">                <span class="n">evaluate_point</span><span class="p">,</span>
</span><span data-line="1558">                <span class="bp">self</span><span class="o">.</span><span class="n">_problem_future</span><span class="p">,</span>
</span><span data-line="1559">                <span class="n">point</span><span class="p">,</span>
</span><span data-line="1560">                <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Function may have side effects</span>
</span><span data-line="1561">            <span class="p">)</span>
</span><span data-line="1562">            <span class="n">new_futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
</span><span data-line="1563">
</span><span data-line="1564">        <span class="c1"># and don&#39;t forget, this updates the statistics</span>
</span><span data-line="1565">        <span class="bp">self</span><span class="o">.</span><span class="n">_add_tasks</span><span class="p">(</span><span class="n">new_futures</span><span class="p">)</span>
</span><span data-line="1566">
</span><span data-line="1567">        <span class="c1"># collect new results for each finished task, hand them over to result DB</span>
</span><span data-line="1568">        <span class="n">new_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1569">        <span class="k">for</span> <span class="n">future_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span><span class="p">:</span>
</span><span data-line="1570">            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">future_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1571">            <span class="k">if</span> <span class="n">future</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1572">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="1573">                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span><span data-line="1574">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="1575">                        <span class="n">new_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span data-line="1576">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1577">                        <span class="n">new_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span data-line="1578">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="1579">                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Task failed with error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</span><span data-line="1580">
</span><span data-line="1581">        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">+=</span> <span class="n">new_results</span>
</span><span data-line="1582">
</span><span data-line="1583">    <span class="k">def</span><span class="w"> </span><span class="nf">_run_process_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
</span><span data-line="1584"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run evaluation using subprocess calls.&quot;&quot;&quot;</span>
</span><span data-line="1585">        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
</span><span data-line="1586">        <span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
</span><span data-line="1587">        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
</span><span data-line="1588">        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span data-line="1589">        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
</span><span data-line="1590">        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span data-line="1591">
</span><span data-line="1592">        <span class="c1"># Submit each point as a separate subprocess task</span>
</span><span data-line="1593">        <span class="n">new_processes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1594">        <span class="n">temp_files</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1595">        <span class="n">task_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1596">
</span><span data-line="1597">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
</span><span data-line="1598">            <span class="c1"># Create task ID</span>
</span><span data-line="1599">            <span class="n">task_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;process_task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="1600">            <span class="n">task_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span data-line="1601">
</span><span data-line="1602">            <span class="c1"># Create temporary file for the point</span>
</span><span data-line="1603">            <span class="n">point_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
</span><span data-line="1604">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1605">                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">point_file</span><span class="p">)</span>
</span><span data-line="1606">                <span class="n">point_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1607">                <span class="n">temp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="1608">
</span><span data-line="1609">                <span class="c1"># Create temporary file for the result</span>
</span><span data-line="1610">                <span class="n">result_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
</span><span data-line="1611">                <span class="n">result_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1612">                <span class="n">temp_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="1613">
</span><span data-line="1614">                <span class="c1"># Launch subprocess</span>
</span><span data-line="1615">                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
</span><span data-line="1616">                    <span class="s2">&quot;python3&quot;</span><span class="p">,</span>
</span><span data-line="1617">                    <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
</span><span data-line="1618">                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span data-line="1619"><span class="s2">import pickle</span>
</span><span data-line="1620"><span class="s2">import sys</span>
</span><span data-line="1621"><span class="s2">sys.path.insert(0, &#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span><span class="si">}</span><span class="s2">&#39;)</span>
</span><span data-line="1622"><span class="s2">from panobbgo.utils import evaluate_point_subprocess</span>
</span><span data-line="1623">
</span><span data-line="1624"><span class="s2"># Load problem and point</span>
</span><span data-line="1625"><span class="s2">with open(&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, &#39;rb&#39;) as f:</span>
</span><span data-line="1626"><span class="s2">    problem = pickle.load(f)</span>
</span><span data-line="1627"><span class="s2">with open(&#39;</span><span class="si">{</span><span class="n">point_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, &#39;rb&#39;) as f:</span>
</span><span data-line="1628"><span class="s2">    point = pickle.load(f)</span>
</span><span data-line="1629">
</span><span data-line="1630"><span class="s2"># Evaluate and save result</span>
</span><span data-line="1631"><span class="s2">result = evaluate_point_subprocess(problem, point)</span>
</span><span data-line="1632"><span class="s2">with open(&#39;</span><span class="si">{</span><span class="n">result_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, &#39;wb&#39;) as f:</span>
</span><span data-line="1633"><span class="s2">    pickle.dump(result, f)</span>
</span><span data-line="1634"><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
</span><span data-line="1635">                <span class="p">]</span>
</span><span data-line="1636">
</span><span data-line="1637">                <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span data-line="1638">                <span class="n">new_processes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">process</span><span class="p">,</span> <span class="n">result_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task_id</span><span class="p">))</span>
</span><span data-line="1639">
</span><span data-line="1640">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="1641">                <span class="n">point_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1642">                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">point_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="1643">                <span class="k">if</span> <span class="s2">&quot;result_file&quot;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
</span><span data-line="1644">                    <span class="n">result_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1645">                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">result_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="1646">                <span class="k">raise</span> <span class="n">e</span>
</span><span data-line="1647">
</span><span data-line="1648">        <span class="c1"># Add tasks to pending (for compatibility with existing code)</span>
</span><span data-line="1649">        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">task_ids</span><span class="p">:</span>
</span><span data-line="1650">            <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_id</span>  <span class="c1"># Mock pending entry</span>
</span><span data-line="1651">
</span><span data-line="1652">        <span class="c1"># Wait for all processes to complete and collect results</span>
</span><span data-line="1653">        <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1654">        <span class="n">new_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1655">        <span class="k">for</span> <span class="n">process</span><span class="p">,</span> <span class="n">result_file</span><span class="p">,</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">new_processes</span><span class="p">:</span>
</span><span data-line="1656">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1657">                <span class="n">process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># 30 second timeout per evaluation</span>
</span><span data-line="1658">                <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1659">                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">result_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span data-line="1660">                        <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span data-line="1661">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="1662">                            <span class="n">new_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span data-line="1663">                        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1664">                            <span class="n">new_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span data-line="1665">                    <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span data-line="1666">                    <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span data-line="1667">                <span class="k">else</span><span class="p">:</span>
</span><span data-line="1668">                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span data-line="1669">                        <span class="s2">&quot;Subprocess evaluation failed with return code: </span><span class="si">%d</span><span class="s2">&quot;</span>
</span><span data-line="1670">                        <span class="o">%</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span>
</span><span data-line="1671">                    <span class="p">)</span>
</span><span data-line="1672">            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
</span><span data-line="1673">                <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span data-line="1674">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Subprocess evaluation timed out&quot;</span><span class="p">)</span>
</span><span data-line="1675">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="1676">                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Task failed with error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</span><span data-line="1677">
</span><span data-line="1678">        <span class="c1"># Remove completed tasks from pending</span>
</span><span data-line="1679">        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span><span class="p">:</span>
</span><span data-line="1680">            <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1681">
</span><span data-line="1682">        <span class="c1"># Clean up temporary files</span>
</span><span data-line="1683">        <span class="k">for</span> <span class="n">temp_file</span> <span class="ow">in</span> <span class="n">temp_files</span><span class="p">:</span>
</span><span data-line="1684">            <span class="k">try</span><span class="p">:</span>
</span><span data-line="1685">                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
</span><span data-line="1686">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span data-line="1687">                <span class="k">pass</span>
</span><span data-line="1688">
</span><span data-line="1689">        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">+=</span> <span class="n">new_results</span>
</span><span data-line="1690">
</span><span data-line="1691">    <span class="k">def</span><span class="w"> </span><span class="nf">_run_threaded_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
</span><span data-line="1692"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1693"><span class="sd">        Run evaluation using thread pool for fast testing.</span>
</span><span data-line="1694">
</span><span data-line="1695"><span class="sd">        This is much faster than subprocess evaluation for pure Python functions</span>
</span><span data-line="1696"><span class="sd">        since it avoids process creation overhead and pickle serialization.</span>
</span><span data-line="1697"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1698">        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">time_mod</span>
</span><span data-line="1699">
</span><span data-line="1700">        <span class="c1"># Prepare for result collection</span>
</span><span data-line="1701">        <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1702">        <span class="n">new_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1703">
</span><span data-line="1704">        <span class="c1"># Submit all points to thread pool if any</span>
</span><span data-line="1705">        <span class="k">if</span> <span class="n">points</span><span class="p">:</span>
</span><span data-line="1706">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
</span><span data-line="1707">                <span class="n">task_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;thread_task_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span data-line="1708">                <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
</span><span data-line="1709">                <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>
</span><span data-line="1710">                <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>
</span><span data-line="1711">                <span class="c1"># Store start time for walltime calculation</span>
</span><span data-line="1712">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_task_start_times&#39;</span><span class="p">):</span>
</span><span data-line="1713">                    <span class="bp">self</span><span class="o">.</span><span class="n">_task_start_times</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1714">                <span class="bp">self</span><span class="o">.</span><span class="n">_task_start_times</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="1715">
</span><span data-line="1716">        <span class="c1"># Wait for completion with short timeout for responsiveness</span>
</span><span data-line="1717">        <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1718">        <span class="n">new_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1719">
</span><span data-line="1720">        <span class="c1"># Check which futures are done</span>
</span><span data-line="1721">        <span class="n">completed_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1722">        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="1723">            <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
</span><span data-line="1724">                <span class="n">completed_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span data-line="1725">                <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span data-line="1726">                <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span data-line="1727">
</span><span data-line="1728">                <span class="c1"># Record wall time</span>
</span><span data-line="1729">                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_task_start_times&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_start_times</span><span class="p">:</span>
</span><span data-line="1730">                    <span class="bp">self</span><span class="o">.</span><span class="n">tasks_walltimes</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_start_times</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
</span><span data-line="1731">                    <span class="bp">self</span><span class="o">.</span><span class="n">_task_start_times</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</span><span data-line="1732">
</span><span data-line="1733">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="1734">                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span><span data-line="1735">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span data-line="1736">                        <span class="n">new_results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span data-line="1737">                    <span class="k">else</span><span class="p">:</span>
</span><span data-line="1738">                        <span class="n">new_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span data-line="1739">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span data-line="1740">                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Threaded evaluation failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</span><span data-line="1741">
</span><span data-line="1742">        <span class="c1"># Clean up completed futures</span>
</span><span data-line="1743">        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">completed_ids</span><span class="p">:</span>
</span><span data-line="1744">            <span class="bp">self</span><span class="o">.</span><span class="n">_futures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1745">            <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span data-line="1746">
</span><span data-line="1747">        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">+=</span> <span class="n">new_results</span>
</span><span data-line="1748">
</span><span data-line="1749">    <span class="k">def</span><span class="w"> </span><span class="nf">_update_progress_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1750"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1751"><span class="sd">        Update the progress status line with current optimization information.</span>
</span><span data-line="1752"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1753">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;panobbgo_logger&#39;</span><span class="p">):</span>
</span><span data-line="1754">            <span class="k">return</span>
</span><span data-line="1755">
</span><span data-line="1756">        <span class="n">progress_reporter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">panobbgo_logger</span><span class="o">.</span><span class="n">progress_reporter</span>
</span><span data-line="1757">        <span class="k">if</span> <span class="ow">not</span> <span class="n">progress_reporter</span><span class="o">.</span><span class="n">status_enabled</span><span class="p">:</span>
</span><span data-line="1758">            <span class="k">return</span>
</span><span data-line="1759">
</span><span data-line="1760">        <span class="c1"># Gather status information</span>
</span><span data-line="1761">        <span class="n">current_evals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
</span><span data-line="1762">        <span class="k">try</span><span class="p">:</span>
</span><span data-line="1763">            <span class="n">max_evals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_eval</span><span class="p">)</span>
</span><span data-line="1764">        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span data-line="1765">            <span class="n">max_evals</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span data-line="1766">        <span class="n">budget_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_evals</span> <span class="o">/</span> <span class="n">max_evals</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">max_evals</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span data-line="1767">
</span><span data-line="1768">        <span class="c1"># Calculate ETA</span>
</span><span data-line="1769">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_start&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1770">            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span>
</span><span data-line="1771">            <span class="k">if</span> <span class="n">current_evals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span data-line="1772">                <span class="n">avg_time_per_eval</span> <span class="o">=</span> <span class="n">elapsed_time</span> <span class="o">/</span> <span class="n">current_evals</span>
</span><span data-line="1773">                <span class="n">remaining_evals</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_evals</span> <span class="o">-</span> <span class="n">current_evals</span><span class="p">)</span>
</span><span data-line="1774">                <span class="n">eta_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">avg_time_per_eval</span> <span class="o">*</span> <span class="n">remaining_evals</span><span class="p">)</span>
</span><span data-line="1775">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1776">                <span class="n">eta_seconds</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1777">        <span class="k">else</span><span class="p">:</span>
</span><span data-line="1778">            <span class="n">eta_seconds</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1779">
</span><span data-line="1780">        <span class="c1"># Get convergence estimate (simplified: distance to best known)</span>
</span><span data-line="1781">        <span class="n">convergence</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span data-line="1782">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;best&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1783">            <span class="c1"># Simple convergence measure: could be improved</span>
</span><span data-line="1784">            <span class="n">convergence</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">100.0</span><span class="p">,</span> <span class="p">(</span><span class="n">current_evals</span> <span class="o">/</span> <span class="n">max_evals</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span data-line="1785">
</span><span data-line="1786">        <span class="c1"># Get best function value</span>
</span><span data-line="1787">        <span class="n">best_value</span> <span class="o">=</span> <span class="kc">None</span>
</span><span data-line="1788">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;best&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1789">            <span class="n">best_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best</span><span class="o">.</span><span class="n">fx</span>
</span><span data-line="1790">
</span><span data-line="1791">        <span class="c1"># Get strategy-specific information (for bandit strategies)</span>
</span><span data-line="1792">        <span class="n">extra_fields</span> <span class="o">=</span> <span class="p">{}</span>
</span><span data-line="1793">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_get_status_info&#39;</span><span class="p">):</span>
</span><span data-line="1794">            <span class="n">extra_fields</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_get_status_info&#39;</span><span class="p">)()</span>
</span><span data-line="1795">
</span><span data-line="1796">        <span class="c1"># Update status</span>
</span><span data-line="1797">        <span class="n">progress_reporter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span>
</span><span data-line="1798">            <span class="n">budget_pct</span><span class="o">=</span><span class="n">budget_pct</span><span class="p">,</span>
</span><span data-line="1799">            <span class="n">eta_seconds</span><span class="o">=</span><span class="n">eta_seconds</span><span class="p">,</span>
</span><span data-line="1800">            <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
</span><span data-line="1801">            <span class="n">best_value</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">best_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">best_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span data-line="1802">            <span class="n">current_evals</span><span class="o">=</span><span class="n">current_evals</span><span class="p">,</span>
</span><span data-line="1803">            <span class="n">max_evals</span><span class="o">=</span><span class="n">max_evals</span><span class="p">,</span>
</span><span data-line="1804">            <span class="n">extra_fields</span><span class="o">=</span><span class="n">extra_fields</span>
</span><span data-line="1805">        <span class="p">)</span>
</span><span data-line="1806">
</span><span data-line="1807">    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_points_safely</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">until</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span data-line="1808"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1809"><span class="sd">        Safely collect points from heuristics with timeout protection.</span>
</span><span data-line="1810"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1811">
</span><span data-line="1812">        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1813">        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1814">        <span class="n">max_attempts</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Approx 2 seconds</span>
</span><span data-line="1815">
</span><span data-line="1816">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span data-line="1817">            <span class="c1"># Check termination</span>
</span><span data-line="1818">            <span class="k">if</span> <span class="n">until</span><span class="p">:</span>
</span><span data-line="1819">                <span class="k">if</span> <span class="n">until</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span data-line="1820">                    <span class="k">break</span>
</span><span data-line="1821">            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
</span><span data-line="1822">                <span class="k">break</span>
</span><span data-line="1823">
</span><span data-line="1824">            <span class="c1"># Try to get points</span>
</span><span data-line="1825">            <span class="n">initial_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</span><span data-line="1826">            <span class="n">new_points</span> <span class="o">=</span> <span class="n">selector</span><span class="p">()</span>
</span><span data-line="1827">
</span><span data-line="1828">            <span class="k">if</span> <span class="n">new_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1829">                <span class="c1"># Selector signalled to stop (e.g. no active heuristics)</span>
</span><span data-line="1830">                <span class="k">break</span>
</span><span data-line="1831">
</span><span data-line="1832">            <span class="k">if</span> <span class="n">new_points</span><span class="p">:</span>
</span><span data-line="1833">                <span class="n">points</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_points</span><span class="p">)</span>
</span><span data-line="1834">
</span><span data-line="1835">            <span class="c1"># Check progress</span>
</span><span data-line="1836">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="n">initial_count</span><span class="p">:</span>
</span><span data-line="1837">                <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span data-line="1838">                <span class="k">if</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="n">max_attempts</span><span class="p">:</span>
</span><span data-line="1839">                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Timed out waiting for points.&quot;</span><span class="p">)</span>
</span><span data-line="1840">                    <span class="k">break</span>
</span><span data-line="1841">                <span class="n">time_module</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span data-line="1842">            <span class="k">else</span><span class="p">:</span>
</span><span data-line="1843">                <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
</span><span data-line="1844">
</span><span data-line="1845">        <span class="k">return</span> <span class="n">points</span>
</span><span data-line="1846">
<div class="viewcode-block" id="StrategyBase.execute">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.execute">[docs]</a>
</span><span data-line="1847">    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1848"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1849"><span class="sd">        Overwrite this method when you extend this base strategy.</span>
</span><span data-line="1850"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1851">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span data-line="1852">            <span class="s2">&quot;You need to extend the class StrategyBase and overwrite this execute method.&quot;</span>
</span><span data-line="1853">        <span class="p">)</span></div>

</span><span data-line="1854">
</span><span data-line="1855">    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1856"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1857"><span class="sd">        cleanup + shutdown</span>
</span><span data-line="1858"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1859">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up strategy...&quot;</span><span class="p">)</span>
</span><span data-line="1860">        <span class="c1"># Signal termination to all event bus subscribers</span>
</span><span data-line="1861">        <span class="bp">self</span><span class="o">.</span><span class="n">eventbus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;finished&quot;</span><span class="p">,</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span data-line="1862">        <span class="bp">self</span><span class="o">.</span><span class="n">_end</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="1863">
</span><span data-line="1864">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
</span><span data-line="1865">            <span class="c1"># Cancel any outstanding Dask futures</span>
</span><span data-line="1866">            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span data-line="1867">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="1868">                    <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
</span><span data-line="1869">                <span class="k">except</span><span class="p">:</span>
</span><span data-line="1870">                    <span class="k">pass</span>
</span><span data-line="1871">
</span><span data-line="1872">            <span class="c1"># Close Dask client and cluster</span>
</span><span data-line="1873">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_client&quot;</span><span class="p">):</span>
</span><span data-line="1874">                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1875">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_cluster&quot;</span><span class="p">):</span>
</span><span data-line="1876">                <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1877">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;processes&quot;</span><span class="p">:</span>
</span><span data-line="1878">            <span class="c1"># Clean up problem file for process evaluation</span>
</span><span data-line="1879">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_problem_file&quot;</span><span class="p">):</span>
</span><span data-line="1880">                <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span data-line="1881">
</span><span data-line="1882">                <span class="k">try</span><span class="p">:</span>
</span><span data-line="1883">                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_problem_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span data-line="1884">                <span class="k">except</span><span class="p">:</span>
</span><span data-line="1885">                    <span class="k">pass</span>
</span><span data-line="1886">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">evaluation_method</span> <span class="o">==</span> <span class="s2">&quot;threaded&quot;</span><span class="p">:</span>
</span><span data-line="1887">            <span class="c1"># Shutdown thread pool</span>
</span><span data-line="1888">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_thread_pool&quot;</span><span class="p">):</span>
</span><span data-line="1889">                <span class="bp">self</span><span class="o">.</span><span class="n">_thread_pool</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span data-line="1890">
</span><span data-line="1891">        <span class="c1"># Finalize progress reporting</span>
</span><span data-line="1892">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;panobbgo_logger&#39;</span><span class="p">):</span>
</span><span data-line="1893">            <span class="bp">self</span><span class="o">.</span><span class="n">panobbgo_logger</span><span class="o">.</span><span class="n">progress_reporter</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</span><span data-line="1894">
</span><span data-line="1895">        <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_start&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
</span><span data-line="1896">        <span class="n">loops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;loops&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
</span><span data-line="1897">        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span data-line="1898">            <span class="s2">&quot;Strategy &#39;</span><span class="si">%s</span><span class="s2">&#39; finished after </span><span class="si">%.3f</span><span class="s2"> [s] and </span><span class="si">%d</span><span class="s2"> loops.&quot;</span>
</span><span data-line="1899">            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">loops</span><span class="p">)</span>
</span><span data-line="1900">        <span class="p">)</span>
</span><span data-line="1901">
</span><span data-line="1902">        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span><span data-line="1903">        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span><span data-line="1904">        <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">__stop__</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzers</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="p">]</span>
</span><span data-line="1905">
</span><span data-line="1906">        <span class="c1"># Close Dask client and cluster</span>
</span><span data-line="1907">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_client&quot;</span><span class="p">):</span>
</span><span data-line="1908">            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1909">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_cluster&quot;</span><span class="p">):</span>
</span><span data-line="1910">            <span class="bp">self</span><span class="o">.</span><span class="n">_cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span data-line="1911">
</span><span data-line="1912">
</span><span data-line="1913">
<div class="viewcode-block" id="StrategyBase.on_converged">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.on_converged">[docs]</a>
</span><span data-line="1914">    <span class="k">def</span><span class="w"> </span><span class="nf">on_converged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">stats</span><span class="p">):</span>
</span><span data-line="1915"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1916"><span class="sd">        Called when the Convergence analyzer detects convergence.</span>
</span><span data-line="1917"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1918">        <span class="n">stop_on_conv</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;stop_on_convergence&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span data-line="1919">        <span class="k">if</span> <span class="n">stop_on_conv</span><span class="p">:</span>
</span><span data-line="1920">            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convergence detected: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">. Stopping strategy.&quot;</span><span class="p">)</span>
</span><span data-line="1921">            <span class="bp">self</span><span class="o">.</span><span class="n">_stop_requested</span> <span class="o">=</span> <span class="kc">True</span></div>

</span><span data-line="1922">
</span><span data-line="1923">    <span class="k">def</span><span class="w"> </span><span class="nf">_add_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_futures</span><span class="p">):</span>
</span><span data-line="1924"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1925"><span class="sd">        Accounting routine for the parallel tasks, only used by :meth:`.run`.</span>
</span><span data-line="1926"><span class="sd">        Adapted for Dask futures instead of IPython message IDs.</span>
</span><span data-line="1927"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1928">        <span class="k">if</span> <span class="n">new_futures</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span data-line="1929">            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">new_futures</span><span class="p">:</span>
</span><span data-line="1930">                <span class="c1"># Use future.key as identifier</span>
</span><span data-line="1931">                <span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span>
</span><span data-line="1932">
</span><span data-line="1933">        <span class="c1"># Find completed futures</span>
</span><span data-line="1934">        <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1935">        <span class="n">completed_keys</span> <span class="o">=</span> <span class="p">[]</span>
</span><span data-line="1936">
</span><span data-line="1937">        <span class="k">for</span> <span class="n">future_id</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span data-line="1938">            <span class="k">if</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
</span><span data-line="1939">                <span class="bp">self</span><span class="o">.</span><span class="n">new_finished</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future_id</span><span class="p">)</span>
</span><span data-line="1940">                <span class="n">completed_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future_id</span><span class="p">)</span>
</span><span data-line="1941">                <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future_id</span><span class="p">)</span>
</span><span data-line="1942">
</span><span data-line="1943">                <span class="c1"># Calculate elapsed time if available</span>
</span><span data-line="1944">                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="s2">&quot;done&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
</span><span data-line="1945">                    <span class="k">try</span><span class="p">:</span>
</span><span data-line="1946">                        <span class="c1"># Get task duration from Dask</span>
</span><span data-line="1947">                        <span class="c1"># Note: This is approximate, based on completion time</span>
</span><span data-line="1948">                        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_walltimes</span><span class="p">[</span><span class="n">future_id</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># placeholder</span>
</span><span data-line="1949">                    <span class="k">except</span><span class="p">:</span>
</span><span data-line="1950">                        <span class="k">pass</span>
</span><span data-line="1951">
</span><span data-line="1952">        <span class="k">if</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_last</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">show_interval</span><span class="p">):</span>
</span><span data-line="1953">            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</span><span data-line="1954">            <span class="bp">self</span><span class="o">.</span><span class="n">show_last</span> <span class="o">=</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span data-line="1955">
<div class="viewcode-block" id="StrategyBase.info">
<a class="viewcode-back" href="../../core.html#panobbgo.core.StrategyBase.info">[docs]</a>
</span><span data-line="1956">    <span class="k">def</span><span class="w"> </span><span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1957"><span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
</span><span data-line="1958">        <span class="n">avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_time_per_task</span>
</span><span data-line="1959">        <span class="n">pend</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span>
</span><span data-line="1960">        <span class="n">fini</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">)</span>
</span><span data-line="1961">        <span class="n">peval</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
</span><span data-line="1962">        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
</span><span data-line="1963">            <span class="s2">&quot;</span><span class="si">{0:4d}</span><span class="s2"> (</span><span class="si">{1:4d}</span><span class="s2">) pnts | Tasks: </span><span class="si">{2:3d}</span><span class="s2"> pend, </span><span class="si">{3:3d}</span><span class="s2"> finished | &quot;</span>
</span><span data-line="1964">            <span class="s2">&quot;</span><span class="si">{4:6.3f}</span><span class="s2"> [s] cpu, </span><span class="si">{5:6.3f}</span><span class="s2"> [s] wall, </span><span class="si">{6:6.3f}</span><span class="s2"> [s/task]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span data-line="1965">                <span class="n">peval</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">),</span> <span class="n">pend</span><span class="p">,</span> <span class="n">fini</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_cpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_wall</span><span class="p">,</span> <span class="n">avg</span>
</span><span data-line="1966">            <span class="p">)</span>
</span><span data-line="1967">        <span class="p">)</span>
</span><span data-line="1968">        <span class="bp">self</span><span class="o">.</span><span class="n">slogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

</span><span data-line="1969">
</span><span data-line="1970">    <span class="nd">@property</span>
</span><span data-line="1971">    <span class="k">def</span><span class="w"> </span><span class="nf">avg_time_per_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1972"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1973"><span class="sd">        :return float: average time per task</span>
</span><span data-line="1974"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1975">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks_walltimes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span data-line="1976">            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks_walltimes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span data-line="1977">        <span class="bp">self</span><span class="o">.</span><span class="n">slogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;avg time per task for 0 tasks! -&gt; returning NaN&quot;</span><span class="p">)</span>
</span><span data-line="1978">        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span data-line="1979">
</span><span data-line="1980">    <span class="nd">@property</span>
</span><span data-line="1981">    <span class="k">def</span><span class="w"> </span><span class="nf">time_wall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1982"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1983"><span class="sd">        wall time in seconds</span>
</span><span data-line="1984"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1985">        <span class="k">return</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_start</span>
</span><span data-line="1986">
</span><span data-line="1987">    <span class="nd">@property</span>
</span><span data-line="1988">    <span class="k">def</span><span class="w"> </span><span class="nf">time_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1989"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span data-line="1990"><span class="sd">        effective cpu time in seconds</span>
</span><span data-line="1991"><span class="sd">        &quot;&quot;&quot;</span>
</span><span data-line="1992">        <span class="k">return</span> <span class="n">time_module</span><span class="o">.</span><span class="n">process_time</span><span class="p">()</span>
</span><span data-line="1993">
</span><span data-line="1994">    <span class="nd">@property</span>
</span><span data-line="1995">    <span class="k">def</span><span class="w"> </span><span class="nf">time_start_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span data-line="1996">        <span class="k">return</span> <span class="n">time_module</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_start</span><span class="p">)</span></div>

</span></pre></div>
        </article><button class="back-to-top" type="button">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
  </svg>
  <span>Back to top</span>
</button><div class="navigation flex print:hidden"></div></div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2012-2026, Harald Schilly. License Apache 2.0</p>
  
  <p>
    Made with
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials">
<a href="https://github.com/haraldschilly/panobbgo" aria-label="GitHub">
  <iconify-icon icon="simple-icons:github"></iconify-icon>
</a></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=1859ee8a"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../_static/shibuya.js?v=cac61aee"></script></body>
</html>